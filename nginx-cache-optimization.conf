# Nginx Configuration for Cache Optimization
# Add this to your nginx server block to improve static asset caching

# Location block for static assets (JS, CSS, images, fonts)
location ~* \.(js|css|png|jpg|jpeg|gif|ico|svg|webp|woff|woff2|ttf|eot)$ {
    # Cache for 1 year for versioned assets
    expires 1y;
    add_header Cache-Control "public, immutable";
    add_header Vary "Accept-Encoding";
    
    # Enable gzip compression
    gzip on;
    gzip_vary on;
    gzip_types text/css text/javascript application/javascript application/json image/svg+xml;
    
    # Security headers
    add_header X-Content-Type-Options nosniff;
}

# Location block for HTML files
location ~* \.html$ {
    # Shorter cache for HTML to allow updates
    expires 1h;
    add_header Cache-Control "public, no-cache, must-revalidate";
    add_header Vary "Accept-Encoding";
    
    # Security headers
    add_header X-Frame-Options DENY;
    add_header X-Content-Type-Options nosniff;
    add_header X-XSS-Protection "1; mode=block";
}

# Preconnect and DNS prefetch for external resources
location = /robots.txt {
    expires 1d;
    add_header Cache-Control "public";
    log_not_found off;
    access_log off;
}

location = /sitemap.xml {
    expires 1d;
    add_header Cache-Control "public";
    log_not_found off;
    access_log off;
}

# Enable browser caching for API responses that are cacheable
location /api/ {
    # Most API responses should not be cached, but add ETag support
    add_header Cache-Control "no-cache, no-store, must-revalidate";
    add_header Pragma "no-cache";
    add_header Expires "0";
    
    # Forward to backend
    proxy_pass http://localhost:5001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}

# Main application files
location / {
    try_files $uri $uri/ @backend;
    
    # Cache for static assets
    expires 1h;
    add_header Cache-Control "public, no-cache, must-revalidate";
}

location @backend {
    proxy_pass http://localhost:5001;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
