<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ClickBit Client Onboarding & Project Agreement</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              "clickbit-blue-dark": "#1a3b73", // Dark blue from logo
              "clickbit-blue-light": "#00bfff", // Light blue/teal from logo gradient
              "clickbit-orange": "#ff8c00", // Orange from cursor
              "clickbit-yellow": "#ffd700", // Yellow from cursor highlights
            },
            fontFamily: {
              sans: ["Sora", "sans-serif"], // Changed default font to Sora
            },
          },
        },
      };
    </script>
    <link
      href="https://fonts.googleapis.com/css2?family=Sora:wght@400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Define CSS variables for custom colors for use in raw CSS */
      :root {
        --tw-clickbit-blue-dark: #1a3b73;
        --tw-clickbit-blue-dark-rgb: 26, 59, 115; /* RGB values for rgba() */
        --tw-clickbit-orange: #ff8c00;
      }

      body {
        font-family: "Sora", sans-serif; /* Ensure Sora is applied */
      }
      .form-section {
        display: none; /* Hide by default */
        opacity: 0;
        transform: translateY(10px);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out, display 0.5s;
      }
      .form-section.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
        transition: opacity 0.5s ease-out, transform 0.5s ease-out; /* Only these transitions when becoming active */
      }
      .required:after {
        content: " *";
        color: #e53e3e; /* Red-600 */
      }
      /* Style for selected service boxes */
      .cost-input.peer:checked + label {
        border-color: var(
          --tw-clickbit-blue-dark
        ); /* Use custom blue for border */
        background-color: rgba(
          var(--tw-clickbit-blue-dark-rgb),
          0.05
        ); /* Light background tint */
        color: var(--tw-clickbit-blue-dark); /* Darker text for selected */
      }
      /* Style for checked checkboxes within other sections */
      .cost-input:checked {
        color: var(--tw-clickbit-blue-dark); /* Checkbox checkmark color */
        border-color: var(--tw-clickbit-blue-dark);
        box-shadow: 0 0 0 3px rgba(var(--tw-clickbit-blue-dark-rgb), 0.3); /* Custom focus ring */
      }
      /* For focus state of inputs */
      input:focus,
      textarea:focus,
      select:focus {
        border-color: var(--tw-clickbit-blue-dark);
        box-shadow: 0 0 0 1px var(--tw-clickbit-blue-dark),
          0 0 0 3px rgba(var(--tw-clickbit-blue-dark-rgb), 0.3);
        outline: none; /* Remove default outline */
      }
      /* Ensure the custom colors are accessible by Tailwind for internal use if needed */
      .bg-clickbit-blue-dark {
        background-color: #1a3b73;
      }
      .text-clickbit-blue-dark {
        color: #1a3b73;
      }
      .border-clickbit-blue-dark {
        border-color: #1a3b73;
      }
      .ring-clickbit-blue-dark {
        --tw-ring-color: #1a3b73;
      }

      .bg-clickbit-orange {
        background-color: #ff8c00;
      }
      .hover\:bg-clickbit-orange-darken:hover {
        background-color: #e67c00; /* Slightly darker orange for hover */
      }
      .text-clickbit-orange {
        color: #ff8c00;
      }

      /* Ensure smooth transitions for custom focus/check states */
      .cost-input,
      input,
      textarea,
      .form-radio,
      select {
        transition: all 0.2s ease-in-out;
      }

      /* Basic print styles for PDF output */
      @media print {
        body {
          -webkit-print-color-adjust: exact !important;
          color-adjust: exact !important;
        }
        .form-section {
          display: block !important; /* Ensure all sections are visible for print */
          opacity: 1 !important;
          transform: none !important;
          page-break-inside: avoid; /* Avoid breaking sections across pages */
        }
        .form-section:not(:last-child) {
          page-break-after: always; /* Force new page after each section */
        }
        .navigation-buttons,
        .mt-10.pt-6.border-t.flex.justify-between.items-center,
        .custom-alert-modal {
          display: none !important; /* Hide navigation and alert in print */
        }
      }
    </style>
  </head>
  <body class="bg-gray-100 text-gray-800">
    <div class="container mx-auto p-4 sm:p-8 max-w-4xl">
      <div class="bg-white p-8 rounded-lg shadow-2xl">
        <h1 class="text-3xl font-bold mb-2 text-center text-clickbit-blue-dark">
          Client Onboarding & Project Agreement
        </h1>
        <p class="text-center text-gray-500 mb-8">
          Welcome to ClickBit! Please fill out this form to get started.
        </p>

        <div id="onboarding-form">
          <div id="page1" class="form-section active">
            <h2
              class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark"
            >
              Page 1: Client & Project Basics
            </h2>

            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                1.1 Client Information
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    for="clientName"
                    class="block text-sm font-medium text-gray-600 required"
                    >Client Name</label
                  >
                  <input
                    type="text"
                    id="clientName"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
                <div>
                  <label
                    for="primaryContact"
                    class="block text-sm font-medium text-gray-600 required"
                    >Primary Contact</label
                  >
                  <input
                    type="text"
                    id="primaryContact"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
                <div>
                  <label
                    for="email"
                    class="block text-sm font-medium text-gray-600 required"
                    >Email</label
                  >
                  <input
                    type="email"
                    id="email"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
                <div>
                  <label
                    for="phone"
                    class="block text-sm font-medium text-gray-600 required"
                    >Phone</label
                  >
                  <input
                    type="tel"
                    id="phone"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
              </div>
            </div>

            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                Budget Consideration
              </h3>
              <div>
                <label class="block text-sm font-medium text-gray-600"
                  >Do you have a specific maximum project budget you cannot
                  exceed?</label
                >
                <div class="mt-2 space-x-4">
                  <label class="inline-flex items-center">
                    <input
                      type="radio"
                      name="budgetOption"
                      value="yes"
                      class="form-radio h-4 w-4 text-clickbit-blue-dark border-gray-300 focus:ring-clickbit-blue-dark"
                    />
                    <span class="ml-2">Yes</span>
                  </label>
                  <label class="inline-flex items-center">
                    <input
                      type="radio"
                      name="budgetOption"
                      value="no"
                      class="form-radio h-4 w-4 text-clickbit-blue-dark border-gray-300 focus:ring-clickbit-blue-dark"
                      checked
                    />
                    <span class="ml-2">No</span>
                  </label>
                </div>
              </div>
              <div id="maxBudgetContainer" class="mt-4" style="display: none">
                <label
                  for="maxBudget"
                  class="block text-sm font-medium text-gray-600"
                  >Maximum Project Budget (AUD$)</label
                >
                <input
                  type="number"
                  id="maxBudget"
                  placeholder="e.g., 15000"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  min="0"
                />
              </div>
            </div>

            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                1.2 Organizational Context
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    for="companyName"
                    class="block text-sm font-medium text-gray-600"
                    >Company/Organisation</label
                  >
                  <input
                    type="text"
                    id="companyName"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
                <div>
                  <label
                    for="companyAddress"
                    class="block text-sm font-medium text-gray-600"
                    >Company Address (Optional)</label
                  >
                  <input
                    type="text"
                    id="companyAddress"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
                <div>
                  <label
                    for="industry"
                    class="block text-sm font-medium text-gray-600"
                    >Industry/Sector (Optional)</label
                  >
                  <input
                    type="text"
                    id="industry"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
              </div>
            </div>

            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                1.3 Project Timelines
              </h3>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <label
                    for="startDate"
                    class="block text-sm font-medium text-gray-600"
                    >Project Start Date</label
                  >
                  <input
                    type="date"
                    id="startDate"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
                <div>
                  <label
                    for="completionDate"
                    class="block text-sm font-medium text-gray-600"
                    >Expected Completion Date</label
                  >
                  <input
                    type="date"
                    id="completionDate"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
                <div class="md:col-span-2">
                  <label
                    for="milestones"
                    class="block text-sm font-medium text-gray-600"
                    >Key Milestones (Optional)</label
                  >
                  <textarea
                    id="milestones"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  ></textarea>
                </div>
              </div>
            </div>
            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                1.4 Additional Information
              </h3>
              <div class="grid grid-cols-1 gap-6">
                <div>
                  <label
                    for="clientBackground"
                    class="block text-sm font-medium text-gray-600"
                    >Client Background/History (Optional)</label
                  >
                  <textarea
                    id="clientBackground"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  ></textarea>
                </div>
                <div>
                  <label
                    for="stakeholders"
                    class="block text-sm font-medium text-gray-600"
                    >Key Stakeholders (Beyond Contact Person)</label
                  >
                  <textarea
                    id="stakeholders"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  ></textarea>
                </div>
                <div>
                  <label
                    for="initialGoals"
                    class="block text-sm font-medium text-gray-600"
                    >Initial Project Goals/Objectives</label
                  >
                  <textarea
                    id="initialGoals"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  ></textarea>
                </div>
              </div>
            </div>

            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                2. Project Overview
              </h3>
              <div class="grid grid-cols-1 gap-6">
                <div>
                  <label
                    for="projectName"
                    class="block text-sm font-medium text-gray-600 required"
                    >Project Name</label
                  >
                  <input
                    type="text"
                    id="projectName"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  />
                </div>
                <div>
                  <label
                    for="projectDescription"
                    class="block text-sm font-medium text-gray-600 required"
                    >Project Description</label
                  >
                  <textarea
                    id="projectDescription"
                    rows="4"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  ></textarea>
                </div>
                <div>
                  <label
                    for="businessObjectives"
                    class="block text-sm font-medium text-gray-600"
                    >Business Objectives</label
                  >
                  <textarea
                    id="businessObjectives"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  ></textarea>
                </div>
                <div>
                  <label
                    for="targetAudience"
                    class="block text-sm font-medium text-gray-600"
                    >Target Audience</label
                  >
                  <textarea
                    id="targetAudience"
                    rows="3"
                    class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                  ></textarea>
                </div>
              </div>
            </div>
          </div>

          <div id="page2" class="form-section">
            <h2
              class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark"
            >
              Page 2: Service Selection
            </h2>
            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                3.1 Primary Service Selection
              </h3>
              <p class="text-sm text-gray-500 mb-4">
                Select one or more services. Your selections will determine the
                next steps.
              </p>
              <div
                id="primary-services-container"
                class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"
              ></div>
            </div>
          </div>

          <div id="service-details-container"></div>

          <div id="page-custom-reqs" class="form-section">
            <h2
              class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark"
            >
              General Project Requirements
            </h2>
            <div
              id="design-requirements-section"
              class="mb-8"
              style="display: none"
            >
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                3.2.1 Design Requirements
              </h3>
              <div
                id="design-requirements-container"
                class="grid grid-cols-1 md:grid-cols-2 gap-6"
              ></div>
            </div>
            <div
              id="functional-requirements-section"
              class="mb-8"
              style="display: none"
            >
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                3.2.2 Functional Requirements
              </h3>
              <div
                id="functional-requirements-container"
                class="grid grid-cols-1 md:grid-cols-2 gap-6"
              ></div>
            </div>
            <div
              id="technical-requirements-section"
              class="mb-8"
              style="display: none"
            >
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                3.2.3 Technical Requirements
              </h3>
              <div
                id="technical-requirements-container"
                class="grid grid-cols-1 md:grid-cols-2 gap-6"
              ></div>
            </div>
            <div
              id="content-requirements-section"
              class="mb-8"
              style="display: none"
            >
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                3.2.4 Content Requirements
              </h3>
              <div
                id="content-requirements-container"
                class="grid grid-cols-1 md:grid-cols-2 gap-6"
              ></div>
            </div>
            <div
              id="additional-requirements-section"
              class="mb-8"
              style="display: none"
            >
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                3.2.5 Additional Project Requirements
              </h3>
              <div>
                <label
                  for="additionalRequirements"
                  class="block text-sm font-medium text-gray-600"
                  >Please detail any other requirements.
                  <span
                    id="additionalRequirementsCost"
                    class="text-gray-500 font-normal hidden"
                    >(Range: AUD$500 - AUD$5,000+)</span
                  ></label
                >
                <textarea
                  id="additionalRequirements"
                  data-cost-low="500"
                  data-cost-high="5000"
                  rows="4"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark cost-input-text"
                ></textarea>
              </div>
            </div>

            <div
              id="project-constraints-section"
              class="mb-8"
              style="display: none"
            >
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                3.2.6 Project Constraints
              </h3>
              <div>
                <label
                  for="projectConstraints"
                  class="block text-sm font-medium text-gray-600"
                  >Please detail any project constraints (e.g., hard deadlines,
                  existing technology stack limitations).</label
                >
                <textarea
                  id="projectConstraints"
                  rows="4"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                ></textarea>
              </div>
            </div>

            <div
              id="future-expansion-section"
              class="mb-8"
              style="display: none"
            >
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                3.2.7 Future Expansion Plans
              </h3>
              <div>
                <label
                  for="futureExpansion"
                  class="block text-sm font-medium text-gray-600"
                  >Outline any future expansion plans for scalability
                  consideration.</label
                >
                <textarea
                  id="futureExpansion"
                  rows="4"
                  class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                ></textarea>
              </div>
            </div>
          </div>

          <div id="page-digital-marketing" class="form-section">
            <h2
              class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark"
            >
              Digital Marketing Services
            </h2>
            <div id="digital-marketing-container"></div>
          </div>

          <div id="page-design-services" class="form-section">
            <h2
              class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark"
            >
              Design Services
            </h2>
            <div id="design-services-container"></div>
          </div>

          <div id="page-system-updates" class="form-section">
            <h2
              class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark"
            >
              Existing System Updates
            </h2>
            <div id="system-updates-container" class="space-y-6"></div>
          </div>

          <div id="page-timeline-budget" class="form-section">
            <h2
              class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark"
            >
              Project Summary & Estimated Budget
            </h2>

            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                6. Project Timeline (Estimated)
              </h3>
              <ul class="list-disc list-inside space-y-2 text-gray-600">
                <li><strong>Phase 1:</strong> Planning & Requirements</li>
                <li><strong>Phase 2:</strong> Design & Development</li>
                <li><strong>Phase 3:</strong> Testing & Quality Assurance</li>
                <li><strong>Phase 4:</strong> Launch & Deployment</li>
              </ul>
            </div>
            <div class="mb-8">
              <h3 class="text-xl font-semibold mb-4 text-gray-700">
                7. Estimated Budget
              </h3>
              <div
                class="bg-clickbit-blue-dark bg-opacity-5 border border-clickbit-blue-dark border-opacity-20 p-6 rounded-lg"
              >
                <div id="cost-estimation" class="mb-4">
                  <h4 class="text-lg font-semibold text-gray-800">
                    Estimated Project Cost Range:
                  </h4>
                  <p
                    id="total-cost"
                    class="text-3xl font-bold text-clickbit-blue-dark"
                  >
                    AUD$0 - AUD$0
                  </p>
                  <p class="text-sm text-gray-500 mt-2">
                    This is an approximation based on your selections. The
                    actual price may vary and will be confirmed in a detailed
                    invoice/estimate after review.
                  </p>
                </div>
                <div
                  id="budget-feedback"
                  class="hidden my-4 p-4 bg-red-100 border border-red-300 text-red-800 rounded-lg"
                ></div>
                <div id="cost-breakdown-container" class="mb-4">
                  <h4 class="text-lg font-semibold text-gray-800">
                    Cost Breakdown:
                  </h4>
                  <div id="cost-breakdown" class="mt-2 space-y-1 text-sm"></div>
                </div>
              </div>
            </div>
          </div>
          <div id="page-agreement" class="form-section">
            <h2
              class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark"
            >
              10. Agreement Acknowledgement
            </h2>
            <div
              id="agreement-text"
              class="prose max-w-none h-64 overflow-y-auto border p-4 rounded-md bg-gray-50 text-sm"
            ></div>

            <h2
              class="text-2xl font-semibold mb-6 mt-8 border-b pb-2 text-clickbit-blue-dark"
            >
              11. Client Acknowledgment
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
              <div>
                <h3 class="text-lg font-semibold mb-2">For the Client</h3>
                <div class="space-y-4">
                  <div>
                    <label
                      for="clientNameSign"
                      class="block text-sm font-medium text-gray-600 required"
                      >Name</label
                    >
                    <input
                      type="text"
                      id="clientNameSign"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100"
                      readonly
                    />
                  </div>
                  <div>
                    <label
                      for="clientSignature"
                      class="block text-sm font-medium text-gray-600 required"
                      >Signature</label
                    >
                    <input
                      type="text"
                      id="clientSignature"
                      placeholder="Type your full name to sign"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                    />
                  </div>
                  <div>
                    <label
                      for="clientTitle"
                      class="block text-sm font-medium text-gray-600"
                      >Designation/Title</label
                    >
                    <input
                      type="text"
                      id="clientTitle"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark"
                    />
                  </div>
                  <div>
                    <label
                      for="clientDate"
                      class="block text-sm font-medium text-gray-600 required"
                      >Date</label
                    >
                    <input
                      type="date"
                      id="clientDate"
                      class="mt-1 block w-full rounded-md border-gray-300 shadow-sm bg-gray-100"
                      readonly
                    />
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="mt-10 pt-6 border-t flex justify-between items-center">
          <button
            id="prevBtn"
            class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out"
            style="display: none"
          >
            Previous
          </button>
          <div id="nav-spacer" class="flex-grow"></div>
          <button
            id="nextBtn"
            class="bg-clickbit-blue-dark hover:bg-clickbit-blue-darken text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out"
          >
            Next
          </button>
          <button
            id="submitBtn"
            class="bg-clickbit-orange hover:bg-clickbit-orange-darken text-white font-bold py-2 px-6 rounded-lg transition duration-300 ease-in-out"
            style="display: none"
          >
            Submit Agreement
          </button>
        </div>
      </div>
    </div>

    <div
      id="custom-alert-modal"
      class="fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div class="bg-white p-6 rounded-lg shadow-xl max-w-sm w-full mx-4">
        <h3 id="alert-title" class="text-lg font-bold mb-4 text-gray-800"></h3>
        <p id="alert-message" class="text-gray-700 mb-6"></p>
        <button
          id="alert-ok-btn"
          class="w-full bg-clickbit-blue-dark hover:bg-clickbit-blue-darken text-white font-bold py-2 px-4 rounded-lg transition duration-300"
        >
          OK
        </button>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // --- DATA ---
        const primaryServices = [
          {
            id: "BusinessStarterPack",
            name: "Business Starter Pack",
            description:
              "Launch your brand with essential identity, messaging, and strategy services.",
            cost: [10000, 35000],
          },
          {
            id: "WebService",
            name: "Web Service",
            description:
              "Build a professional, high-performance website or web application.",
            cost: [5000, 20000],
          },
          {
            id: "MobileService",
            name: "Mobile Service",
            description:
              "Create a user-friendly mobile app for iOS, Android, or cross-platform.",
            cost: [15000, 45000],
          },
          {
            id: "DesktopService",
            name: "Desktop Service",
            description:
              "Develop a robust application for Windows, macOS, or Linux systems.",
            cost: [8000, 25000],
          },
          {
            id: "ServerService",
            name: "Server Service",
            description:
              "Set up and manage secure, high-availability server solutions.",
            cost: [3000, 10000],
          },
          {
            id: "CloudService",
            name: "Cloud Service",
            description:
              "Leverage cloud infrastructure for scalable and flexible operations.",
            cost: [4000, 15000],
          },
          {
            id: "AIService",
            name: "AI Service",
            description:
              "Integrate AI and machine learning to create intelligent applications.",
            cost: [20000, 80000],
          },
          {
            id: "DataService",
            name: "Data Service",
            description:
              "Implement data pipelines, analytics, and storage solutions.",
            cost: [5000, 20000],
          },
          {
            id: "SecurityService",
            name: "Security Service",
            description:
              "Protect your systems with comprehensive security and compliance.",
            cost: [6000, 25000],
          },
          {
            id: "NetworkService",
            name: "Network Service",
            description:
              "Design and manage secure and reliable network infrastructures.",
            cost: [2000, 8000],
          },
          {
            id: "StorageService",
            name: "Storage Service",
            description:
              "Set up scalable and secure data storage, either on-premise or in the cloud.",
            cost: [1000, 5000],
          },
          {
            id: "CRMService",
            name: "CRM Service",
            description:
              "Implement a CRM to manage customer relationships and automate sales.",
            cost: [10000, 40000],
          },
          {
            id: "ERPService",
            name: "ERP Service",
            description:
              "Integrate core business processes with a custom ERP solution.",
            cost: [20000, 70000],
          },
          {
            id: "HRMService",
            name: "HRM Service",
            description:
              "Streamline HR operations from payroll to performance management.",
            cost: [8000, 30000],
          },
          {
            id: "SCMService",
            name: "SCM Service",
            description:
              "Optimize your supply chain with inventory and logistics management.",
            cost: [10000, 35000],
          },
          {
            id: "EmailService",
            name: "Email Service",
            description:
              "Establish professional email hosting with migration and security.",
            cost: [1000, 5000],
          },
          {
            id: "DigitalMarketing",
            name: "Digital Marketing",
            description:
              "Grow your online presence with SEO, social media, and paid ads.",
            cost: [2000, 10000],
          },
          {
            id: "DesignService",
            name: "Design Service",
            description:
              "Create stunning visuals, from logos to marketing materials.",
            cost: [8000, 30000],
          },
          {
            id: "SystemUpdateService",
            name: "Existing System Update",
            description:
              "Upgrade and enhance your current websites, apps, or infrastructure.",
            cost: [0, 0],
          },
        ];

        // NEW: Detailed questions for each core service
        const coreServiceDetails = {
          EmailService: {
            title: "Email Service Details",
            fields: [
              {
                id: "emailProvider",
                label: "Preferred Email Provider",
                type: "select",
                options: [
                  "Google Workspace (Gmail)",
                  "Microsoft 365 (Exchange Online)",
                  "Zoho Mail",
                  "Custom/Other",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "numEmailUsers",
                label: "Number of Email Users",
                type: "number",
                cost: [50, 200],
                perUnit: true,
                unitName: "user",
                required: true,
              },
              {
                id: "emailMigrationRequired",
                label: "Email Migration Required?",
                type: "checkbox",
                cost: [500, 2000],
              },
              {
                id: "existingEmailDataSize",
                label: "Estimated Existing Email Data Size (GB)",
                type: "number",
                condition: "emailMigrationRequired",
                cost: [20, 50],
                perUnit: true,
                unitName: "GB",
              },
              {
                id: "archiveMigrationRequired",
                label: "Archive Migration Required?",
                type: "checkbox",
                condition: "emailMigrationRequired",
                cost: [300, 1000],
              },
              {
                id: "emailSecurityFeatures",
                label: "Advanced Security Features (e.g., ATP, DLP)",
                type: "checkbox",
                cost: [100, 500],
              },
              {
                id: "emailTrainingRequired",
                label: "User Training Required?",
                type: "checkbox",
                cost: [200, 800],
              },
              {
                id: "customEmailDomains",
                label: "Number of Custom Domains",
                type: "number",
                cost: [50, 150],
                perUnit: true,
                unitName: "domain",
              },
              {
                id: "emailIntegrationNeeds",
                label: "Integration with other systems (e.g., CRM)",
                type: "textarea",
                cost: [500, 2000],
              },
            ],
          },
          WebService: {
            title: "Web Service Details",
            fields: [
              {
                id: "webType",
                label: "Website Type",
                type: "select",
                options: [
                  "Informational",
                  "E-commerce",
                  "Portfolio",
                  "Blog",
                  "Web Application",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "numWebPages",
                label: "Number of Pages (approx.)",
                type: "number",
                cost: [100, 300],
                perUnit: true,
                unitName: "page",
              },
              {
                id: "cmsPreference",
                label: "CMS Preference",
                type: "select",
                options: [
                  "WordPress",
                  "Shopify",
                  "Custom (React/Vue/Angular)",
                  "No CMS",
                ],
                cost: [0, 0],
              },
              {
                id: "eCommerceFeatures",
                label: "E-commerce Features",
                type: "checkbox_group",
                options: [
                  {
                    id: "paymentGateway",
                    label: "Payment Gateway Integration",
                    cost: [500, 1500],
                  },
                  {
                    id: "productManagement",
                    label: "Product Management System",
                    cost: [800, 2500],
                  },
                  {
                    id: "shippingOptions",
                    label: "Shipping & Tax Configuration",
                    cost: [300, 1000],
                  },
                ],
                condition: "webType:E-commerce",
              },
              {
                id: "userLogin",
                label: "User Login/Registration",
                type: "checkbox",
                cost: [700, 2000],
              },
              {
                id: "blogFunctionality",
                label: "Blog/News Section",
                type: "checkbox",
                cost: [400, 1200],
              },
              {
                id: "thirdPartyAPIs",
                label: "Third-Party API Integrations (e.g., CRM, Marketing)",
                type: "textarea",
                cost: [1000, 4000],
              },
              {
                id: "webPerformanceGoals",
                label: "Performance Goals (e.g., page load speed)",
                type: "textarea",
                cost: [300, 1000],
              },
              {
                id: "seoOptimizationWeb",
                label: "SEO Optimization",
                type: "checkbox",
                cost: [500, 2000],
              }, // Added
              {
                id: "analyticsIntegrationWeb",
                label: "Analytics Integration (Google Analytics, etc.)",
                type: "checkbox",
                cost: [200, 800],
              }, // Added
            ],
          },
          MobileService: {
            title: "Mobile Service Details",
            fields: [
              {
                id: "mobilePlatform",
                label: "Target Platform",
                type: "select",
                options: [
                  "iOS (Native)",
                  "Android (Native)",
                  "Cross-Platform (React Native/Flutter)",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "numMobileFeatures",
                label: "Number of Core Features",
                type: "number",
                cost: [1500, 5000],
                perUnit: true,
                unitName: "feature",
                required: true,
              },
              {
                id: "backendRequired",
                label: "Backend API Development Required?",
                type: "checkbox",
                cost: [5000, 20000],
              },
              {
                id: "offlineSupport",
                label: "Offline Data Support",
                type: "checkbox",
                cost: [1000, 3000],
              },
              {
                id: "pushNotifications",
                label: "Push Notifications",
                type: "checkbox",
                cost: [500, 1500],
              },
              {
                id: "locationServices",
                label: "Location Services (GPS)",
                type: "checkbox",
                cost: [800, 2500],
              },
              {
                id: "paymentIntegrationMobile",
                label: "In-App Payment Integration",
                type: "checkbox",
                cost: [1000, 3000],
              },
              {
                id: "appStoreDeployment",
                label: "App Store Deployment & Management",
                type: "checkbox",
                cost: [1000, 2500],
              },
              {
                id: "analyticsIntegrationMobile",
                label: "Analytics Integration (Firebase, etc.)",
                type: "checkbox",
                cost: [200, 800],
              }, // Added
              {
                id: "customFeaturesDescription",
                label: "Describe any custom/unique features",
                type: "textarea",
                cost: [1000, 5000],
              }, // Added
            ],
          },
          BusinessStarterPack: {
            title: "Business Starter Pack Details",
            fields: [
              {
                id: "brandAudit",
                label: "Brand Audit",
                description:
                  "Review your current brand positioning and materials.",
                type: "checkbox",
                cost: [1000, 3000],
              },
              {
                id: "targetAudienceAnalysis",
                label: "Audience Analysis",
                description:
                  "Define and understand your ideal customer profile.",
                type: "checkbox",
                cost: [800, 2500],
              },
              {
                id: "competitorAnalysis",
                label: "Competitor Analysis",
                description:
                  "Identify and evaluate key competitors in your market.",
                type: "checkbox",
                cost: [700, 2000],
              },
              {
                id: "brandMessaging",
                label: "Brand Messaging",
                description:
                  "Craft your unique brand voice and key marketing messages.",
                type: "checkbox",
                cost: [1500, 5000],
              },
              {
                id: "visualIdentity",
                label: "Visual Identity",
                description:
                  "Develop your logo, color palette, and typography.",
                type: "checkbox",
                cost: [2000, 7000],
              },
              {
                id: "styleGuideCreation",
                label: "Brand Style Guide",
                description:
                  "Create a detailed document to ensure brand consistency.",
                type: "checkbox",
                cost: [3000, 10000],
              },
              {
                id: "marketingStrategy",
                label: "Marketing Strategy",
                description:
                  "Develop a cohesive plan for your marketing efforts.",
                type: "checkbox",
                cost: [2500, 8000],
              },
              {
                id: "contentStrategy",
                label: "Content Strategy",
                description:
                  "Plan content to launch and support your new brand.",
                type: "checkbox",
                cost: [1000, 4000],
              },
              {
                id: "brandGuidelinesDoc",
                label: "Brand Guidelines PDF",
                description:
                  "Deliver a final, shareable PDF of all brand guidelines.",
                type: "checkbox",
                cost: [2000, 6000],
              },
            ],
          },
          DesktopService: {
            title: "Desktop Service Details",
            fields: [
              {
                id: "desktopPlatform",
                label: "Target Operating System",
                type: "select",
                options: ["Windows", "macOS", "Linux", "Cross-Platform"],
                required: true,
                cost: [0, 0],
              },
              {
                id: "desktopFeatures",
                label: "Key Features to Include",
                type: "textarea",
                required: true,
                cost: [1000, 5000],
              },
              {
                id: "localDataStorage",
                label: "Local Data Storage Requirements",
                type: "checkbox",
                cost: [500, 2000],
              },
              {
                id: "offlineFunctionality",
                label: "Offline Functionality Required?",
                type: "checkbox",
                cost: [800, 3000],
              },
              {
                id: "integrationDesktop",
                label: "Integrations with other software/hardware (detail)",
                type: "textarea",
                cost: [700, 3000],
              }, // Added detail in label
              {
                id: "distributionMethod",
                label: "Desired Distribution Method",
                type: "select",
                options: [
                  "Direct Download",
                  "App Store (Microsoft Store, Mac App Store)",
                  "Enterprise Deployment",
                ],
                cost: [0, 0],
              },
              {
                id: "customDesktopNotes",
                label: "Any specific custom requirements for desktop app?",
                type: "textarea",
                cost: [500, 2500],
              }, // Added
            ],
          },
          ServerService: {
            title: "Server Service Details",
            fields: [
              {
                id: "serverType",
                label: "Server Type",
                type: "select",
                options: [
                  "Web Server",
                  "Database Server",
                  "Application Server",
                  "File Server",
                  "Game Server",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "osPreference",
                label: "Operating System Preference",
                type: "select",
                options: ["Linux (Ubuntu, CentOS)", "Windows Server"],
                cost: [0, 0],
              },
              {
                id: "serverLocation",
                label: "Server Location Preference",
                type: "select",
                options: ["On-Premise", "Cloud (AWS, Azure, GCP)", "Hybrid"],
                cost: [0, 0],
              },
              {
                id: "numCPUCores",
                label: "Number of CPU Cores (Recommended)",
                type: "number",
                cost: [50, 150],
                perUnit: true,
                unitName: "core",
              },
              {
                id: "ramGB",
                label: "RAM (GB) (Recommended)",
                type: "number",
                cost: [20, 50],
                perUnit: true,
                unitName: "GB",
              },
              {
                id: "storageTB",
                label: "Storage (TB) (Recommended)",
                type: "number",
                cost: [100, 300],
                perUnit: true,
                unitName: "TB",
              },
              {
                id: "loadBalancing",
                label: "Load Balancing Required?",
                type: "checkbox",
                cost: [1000, 4000],
              },
              {
                id: "highAvailability",
                label: "High Availability (Redundancy) Required?",
                type: "checkbox",
                cost: [2000, 7000],
              },
              {
                id: "backupStrategy",
                label: "Backup & Disaster Recovery Strategy (detail)",
                type: "textarea",
                cost: [800, 3000],
              }, // Added detail in label
              {
                id: "monitoringSetup",
                label: "Server Monitoring & Alerting Setup",
                type: "checkbox",
                cost: [700, 2000],
              }, // Added
            ],
          },
          CloudService: {
            title: "Cloud Service Details",
            fields: [
              {
                id: "cloudProvider",
                label: "Cloud Provider",
                type: "select",
                options: [
                  "AWS",
                  "Microsoft Azure",
                  "Google Cloud Platform (GCP)",
                  "Other/Hybrid",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "cloudServicesNeeded",
                label: "Specific Cloud Services Needed",
                type: "checkbox_group",
                options: [
                  {
                    id: "compute",
                    label: "Compute (VMs, Containers)",
                    cost: [500, 2000],
                  },
                  {
                    id: "storageCloud",
                    label: "Storage (S3, Blobs)",
                    cost: [300, 1000],
                  },
                  {
                    id: "databaseCloud",
                    label: "Databases (RDS, Cosmos DB)",
                    cost: [700, 2500],
                  },
                  {
                    id: "networking",
                    label: "Networking (VPC, Load Balancers)",
                    cost: [400, 1500],
                  },
                  {
                    id: "serverless",
                    label: "Serverless Functions (Lambda, Functions)",
                    cost: [600, 2000],
                  },
                  { id: "mlOps", label: "AI/ML Services", cost: [1500, 5000] },
                ],
                required: true,
              },
              {
                id: "currentCloudUsage",
                label: "Existing Cloud Infrastructure/Migration Needs (detail)",
                type: "textarea",
                cost: [1000, 5000],
              }, // Added detail
              {
                id: "scalabilityNeeds",
                label: "Expected Scalability Needs (detail)",
                type: "textarea",
                cost: [500, 2000],
              }, // Added detail
              {
                id: "costOptimization",
                label: "Cost Optimization Strategy",
                type: "checkbox",
                cost: [500, 1500],
              },
              {
                id: "cloudSecurityAudit",
                label: "Cloud Security Audit & Hardening",
                type: "checkbox",
                cost: [1000, 3500],
              }, // Added
            ],
          },
          AIService: {
            title: "AI Service Details",
            fields: [
              {
                id: "aiApplication",
                label: "Type of AI Application",
                type: "select",
                options: [
                  "Natural Language Processing (NLP)",
                  "Computer Vision",
                  "Predictive Analytics",
                  "Recommendation Systems",
                  "Chatbot/Virtual Assistant",
                  "Robotics",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "dataAvailability",
                label: "Data Availability for Training",
                type: "select",
                options: [
                  "Existing Labeled Data",
                  "Unlabeled Data (Requires Annotation)",
                  "No Data (Requires Collection)",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "modelCustomization",
                label: "Custom Model Development vs. Off-the-shelf",
                type: "select",
                options: [
                  "Custom Model",
                  "Fine-tune Existing Model",
                  "Off-the-shelf API Integration",
                ],
                cost: [0, 0],
              },
              {
                id: "inferenceVolume",
                label: "Expected Inference Volume (Queries/Day)",
                type: "number",
                cost: [0.01, 0.1],
                perUnit: true,
                unitName: "query",
              }, // Small per-unit cost
              {
                id: "aiIntegrationTarget",
                label: "Where will AI be integrated? (detail)",
                type: "textarea",
                cost: [1000, 4000],
              }, // Added detail
              {
                id: "ethicalAI",
                label: "Ethical AI & Bias Mitigation Requirements",
                type: "checkbox",
                cost: [800, 3000],
              },
              {
                id: "aiModelRetraining",
                label: "Ongoing Model Retraining/Maintenance",
                type: "checkbox",
                cost: [1500, 6000],
              }, // Added
            ],
          },
          DataService: {
            title: "Data Service Details",
            fields: [
              {
                id: "dataType",
                label: "Type of Data",
                type: "select",
                options: [
                  "Structured (Databases)",
                  "Unstructured (Text, Images)",
                  "Semi-structured (JSON, XML)",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "dataVolume",
                label: "Estimated Data Volume (TB)",
                type: "number",
                cost: [500, 2000],
                perUnit: true,
                unitName: "TB",
                required: true,
              },
              {
                id: "dataSource",
                label: "Data Source(s) (detail)",
                type: "textarea",
                required: true,
                cost: [0, 0],
              }, // Added detail
              {
                id: "dataProcessing",
                label: "Data Processing Needs",
                type: "checkbox_group",
                options: [
                  { id: "etl", label: "ETL/ELT Pipelines", cost: [1000, 5000] },
                  {
                    id: "dataCleaning",
                    label: "Data Cleaning & Transformation",
                    cost: [800, 3000],
                  },
                  {
                    id: "realtimeProcessing",
                    label: "Real-time Data Processing",
                    cost: [1500, 6000],
                  },
                ],
                required: true,
              },
              {
                id: "dataStorageSolution",
                label: "Data Storage Solution",
                type: "select",
                options: [
                  "Data Lake",
                  "Data Warehouse",
                  "Relational Database",
                  "NoSQL Database",
                ],
                cost: [0, 0],
              },
              {
                id: "dataAnalytics",
                label: "Data Analytics & Reporting Tools",
                type: "checkbox",
                cost: [1000, 4000],
              },
              {
                id: "dataGovernance",
                label: "Data Governance & Compliance (e.g., GDPR, HIPAA)",
                type: "checkbox",
                cost: [1200, 5000],
              },
              {
                id: "dataVisualization",
                label: "Data Visualization Dashboards",
                type: "checkbox",
                cost: [800, 3000],
              }, // Added
            ],
          },
          SecurityService: {
            title: "Security Service Details",
            fields: [
              {
                id: "securityScope",
                label: "Scope of Security Service",
                type: "select",
                options: [
                  "Network Security",
                  "Application Security",
                  "Cloud Security",
                  "Data Security",
                  "Endpoint Security",
                  "Compliance & Governance",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "currentVulnerabilities",
                label: "Known Vulnerabilities/Threats (detail)",
                type: "textarea",
                cost: [0, 0],
              }, // Added detail
              {
                id: "complianceReqs",
                label: "Compliance Requirements (e.g., ISO 27001, PCI DSS)",
                type: "checkbox_group",
                options: [
                  { id: "iso27001", label: "ISO 27001", cost: [2000, 7000] },
                  { id: "pciDss", label: "PCI DSS", cost: [3000, 10000] },
                  { id: "hipaa", label: "HIPAA", cost: [2500, 8000] },
                ],
                cost: [0, 0],
              },
              {
                id: "incidentResponse",
                label: "Incident Response Planning",
                type: "checkbox",
                cost: [1500, 5000],
              },
              {
                id: "penetrationTesting",
                label: "Penetration Testing & Vulnerability Assessment",
                type: "checkbox",
                cost: [2000, 6000],
              },
              {
                id: "securityAudits",
                label: "Regular Security Audits",
                type: "checkbox",
                cost: [1000, 3000],
              },
              {
                id: "securityTraining",
                label: "Employee Security Awareness Training",
                type: "checkbox",
                cost: [500, 2000],
              },
              {
                id: "securityMonitoring",
                label: "Security Information & Event Management (SIEM)",
                type: "checkbox",
                cost: [1800, 7000],
              }, // Added
            ],
          },
          NetworkService: {
            title: "Network Service Details",
            fields: [
              {
                id: "networkType",
                label: "Network Type",
                type: "select",
                options: [
                  "LAN",
                  "WAN",
                  "VPN",
                  "Wireless Network",
                  "Data Center Network",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "numDevices",
                label: "Number of Network Devices (approx.)",
                type: "number",
                cost: [50, 200],
                perUnit: true,
                unitName: "device",
                required: true,
              },
              {
                id: "networkTopology",
                label: "Existing Network Topology Description (detail)",
                type: "textarea",
                cost: [0, 0],
              }, // Added detail
              {
                id: "bandwidthReqs",
                label: "Bandwidth Requirements (Mbps/Gbps) (detail)",
                type: "textarea",
                cost: [300, 1000],
              }, // Added detail
              {
                id: "qosRequired",
                label: "Quality of Service (QoS) Configuration",
                type: "checkbox",
                cost: [800, 2500],
              },
              {
                id: "networkMonitoring",
                label: "Network Monitoring & Alerting",
                type: "checkbox",
                cost: [700, 2000],
              },
              {
                id: "remoteAccess",
                label: "Remote Access Solution (VPN)",
                type: "checkbox",
                cost: [600, 1800],
              },
              {
                id: "firewallConfiguration",
                label: "Firewall Configuration & Management",
                type: "checkbox",
                cost: [1000, 3500],
              }, // Added
            ],
          },
          StorageService: {
            title: "Storage Service Details",
            fields: [
              {
                id: "storageMedium",
                label: "Storage Medium",
                type: "select",
                options: [
                  "Cloud Storage",
                  "On-Premise NAS/SAN",
                  "Direct Attached Storage (DAS)",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "totalStorageTB",
                label: "Total Storage Capacity (TB)",
                type: "number",
                cost: [100, 500],
                perUnit: true,
                unitName: "TB",
                required: true,
              },
              {
                id: "dataAccessFrequency",
                label: "Data Access Frequency",
                type: "select",
                options: [
                  "Frequent (Hot)",
                  "Infrequent (Cool)",
                  "Archival (Cold)",
                ],
                cost: [0, 0],
              },
              {
                id: "dataRedundancy",
                label: "Data Redundancy Needs (e.g., RAID, Geo-replication)",
                type: "checkbox_group",
                options: [
                  { id: "raid", label: "RAID", cost: [300, 1000] },
                  {
                    id: "geoReplication",
                    label: "Geo-replication",
                    cost: [800, 2500],
                  },
                ],
                cost: [0, 0],
              },
              {
                id: "backupRestore",
                label: "Backup & Restore Strategy (detail)",
                type: "textarea",
                cost: [500, 2000],
              }, // Added detail
              {
                id: "dataEncryption",
                label: "Data Encryption (At Rest/In Transit)",
                type: "checkbox",
                cost: [400, 1500],
              },
              {
                id: "fileSharingSolution",
                label: "Enterprise File Sharing Solution",
                type: "checkbox",
                cost: [600, 2000],
              }, // Added
            ],
          },
          CRMService: {
            title: "CRM Service Details",
            fields: [
              {
                id: "crmPlatform",
                label: "CRM Platform Preference",
                type: "select",
                options: [
                  "Salesforce",
                  "HubSpot",
                  "Zoho CRM",
                  "Microsoft Dynamics 365",
                  "Custom/Other",
                ],
                required: true,
                cost: [0, 0],
              },
              {
                id: "crmUsers",
                label: "Number of CRM Users",
                type: "number",
                cost: [30, 100],
                perUnit: true,
                unitName: "user",
                required: true,
              },
              {
                id: "leadManagement",
                label: "Lead Management & Tracking",
                type: "checkbox",
                cost: [500, 1500],
              },
              {
                id: "salesAutomation",
                label: "Sales Automation Workflow",
                type: "checkbox",
                cost: [800, 2500],
              },
              {
                id: "customerSupportCRM",
                label: "Customer Support & Ticketing",
                type: "checkbox",
                cost: [700, 2000],
              },
              {
                id: "marketingAutomationCRM",
                label: "Marketing Automation Integration",
                type: "checkbox",
                cost: [1000, 3000],
              },
              {
                id: "reportingAnalyticsCRM",
                label: "Custom Reporting & Analytics",
                type: "checkbox",
                cost: [600, 2000],
              },
              {
                id: "crmDataMigration",
                label: "Existing Data Migration to CRM",
                type: "checkbox",
                cost: [1000, 4000],
              },
              {
                id: "crmCustomizationNeeds",
                label: "Specific CRM Customization Needs (detail)",
                type: "textarea",
                cost: [1000, 5000],
              }, // Added
            ],
          },
          ERPService: {
            title: "ERP Service Details",
            fields: [
              {
                id: "erpScope",
                label: "ERP Modules Required",
                type: "checkbox_group",
                options: [
                  {
                    id: "financials",
                    label: "Financials/Accounting",
                    cost: [5000, 15000],
                  },
                  {
                    id: "supplyChain",
                    label: "Supply Chain Management",
                    cost: [7000, 20000],
                  },
                  {
                    id: "manufacturing",
                    label: "Manufacturing",
                    cost: [8000, 25000],
                  },
                  { id: "hr", label: "Human Resources", cost: [4000, 12000] },
                  {
                    id: "crmErp",
                    label: "CRM Integration",
                    cost: [3000, 10000],
                  },
                ],
                required: true,
              },
              {
                id: "erpUsers",
                label: "Number of ERP Users",
                type: "number",
                cost: [50, 200],
                perUnit: true,
                unitName: "user",
                required: true,
              },
              {
                id: "currentErpSystem",
                label: "Current ERP System (if any) (detail)",
                type: "textarea",
                cost: [0, 0],
              }, // Added detail
              {
                id: "customizationsRequired",
                label: "Significant Customizations Required?",
                type: "checkbox",
                cost: [10000, 50000],
              },
              {
                id: "dataMigrationERP",
                label: "Existing Data Migration to ERP",
                type: "checkbox",
                cost: [5000, 20000],
              },
              {
                id: "erpTraining",
                label: "User Training & Change Management",
                type: "checkbox",
                cost: [2000, 8000],
              },
              {
                id: "erpReportingNeeds",
                label: "Custom ERP Reporting Needs",
                type: "textarea",
                cost: [1500, 6000],
              }, // Added
            ],
          },
          HRMService: {
            title: "HRM Service Details",
            fields: [
              {
                id: "hrmModules",
                label: "HRM Modules Required",
                type: "checkbox_group",
                options: [
                  {
                    id: "employeeData",
                    label: "Employee Data Management",
                    cost: [1000, 4000],
                  },
                  {
                    id: "payroll",
                    label: "Payroll Management",
                    cost: [1500, 6000],
                  },
                  {
                    id: "recruitment",
                    label: "Recruitment & Onboarding",
                    cost: [1200, 5000],
                  },
                  {
                    id: "performance",
                    label: "Performance Management",
                    cost: [1000, 4000],
                  },
                  {
                    id: "leaveManagement",
                    label: "Leave Management",
                    cost: [800, 3000],
                  },
                  {
                    id: "trainingDev",
                    label: "Training & Development",
                    cost: [700, 2500],
                  },
                ],
                required: true,
              },
              {
                id: "hrmEmployees",
                label: "Number of Employees to Manage",
                type: "number",
                cost: [10, 50],
                perUnit: true,
                unitName: "employee",
                required: true,
              },
              {
                id: "integrationHRM",
                label:
                  "Integration with existing systems (e.g., payroll provider) (detail)",
                type: "textarea",
                cost: [800, 3000],
              }, // Added detail
              {
                id: "hrmCompliance",
                label: "Compliance & Reporting (e.g., ATO, Fair Work)",
                type: "checkbox",
                cost: [500, 2000],
              },
              {
                id: "hrmSelfServicePortal",
                label: "Employee Self-Service Portal",
                type: "checkbox",
                cost: [1000, 4000],
              }, // Added
            ],
          },
          SCMService: {
            title: "SCM Service Details",
            fields: [
              {
                id: "scmModules",
                label: "SCM Modules Required",
                type: "checkbox_group",
                options: [
                  {
                    id: "inventory",
                    label: "Inventory Management",
                    cost: [3000, 10000],
                  },
                  {
                    id: "order",
                    label: "Order Management",
                    cost: [2500, 8000],
                  },
                  {
                    id: "warehouse",
                    label: "Warehouse Management (WMS)",
                    cost: [4000, 15000],
                  },
                  {
                    id: "procurement",
                    label: "Procurement",
                    cost: [2000, 7000],
                  },
                  {
                    id: "logistics",
                    label: "Logistics & Transportation",
                    cost: [3500, 12000],
                  },
                ],
                required: true,
              },
              {
                id: "scmLocations",
                label: "Number of Locations/Warehouses",
                type: "number",
                cost: [500, 2000],
                perUnit: true,
                unitName: "location",
                required: true,
              },
              {
                id: "supplierManagement",
                label: "Supplier Relationship Management (SRM)",
                type: "checkbox",
                cost: [1000, 4000],
              },
              {
                id: "demandForecasting",
                label: "Demand Forecasting & Planning",
                type: "checkbox",
                cost: [1500, 5000],
              },
              {
                id: "realtimeTracking",
                label: "Real-time Tracking & Visibility",
                type: "checkbox",
                cost: [1200, 4500],
              },
              {
                id: "scmIntegration",
                label: "Integration with existing ERP/CRM (detail)",
                type: "textarea",
                cost: [1500, 6000],
              }, // Added detail
              {
                id: "scmAnalytics",
                label: "Supply Chain Analytics & Optimization",
                type: "checkbox",
                cost: [1800, 7000],
              }, // Added
            ],
          },
          // Add more services here as needed, following the same structure
        };

        const designReqs = [
          {
            id: "stylePrefs",
            label: "Style Preferences",
            cost: [500, 1500],
            type: "textarea",
          },
          {
            id: "colorScheme",
            label: "Color Scheme",
            cost: [300, 800],
            type: "text",
          },
          {
            id: "brandGuidelines",
            label: "Existing brand guidelines?",
            cost: [0, 0],
            type: "yesno",
          },
          {
            id: "designInspo",
            label: "Design Inspiration (URLs)",
            cost: [0, 0],
            type: "textarea",
          },
          {
            id: "layoutPrefs",
            label: "Layout Preferences",
            cost: [700, 2000],
            type: "textarea",
            condition: "DesignService",
          }, // Simplified condition
          {
            id: "responsiveNeeds",
            label: "Responsive Design Needs",
            cost: [1000, 3000],
            type: "checkbox",
            condition: "DesignService",
          }, // Simplified condition
          {
            id: "accessibility",
            label: "Accessibility Requirements (WCAG)",
            cost: [800, 2500],
            type: "checkbox",
            condition: "DesignService",
          }, // Simplified condition
          {
            id: "specialElements",
            label: "Special Design Elements",
            cost: [500, 2000],
            type: "textarea",
            condition: "DesignService",
          }, // Simplified condition
        ];

        const functionalReqs = [
          {
            id: "coreFeatures",
            label: "Core Features (describe)",
            cost: [1000, 5000],
            type: "textarea",
          },
          {
            id: "userInteractions",
            label: "User Interactions",
            cost: [800, 2500],
            type: "textarea",
          },
          {
            id: "workflowReqs",
            label: "Workflow Requirements",
            cost: [1500, 6000],
            type: "textarea",
          },
          {
            id: "integrationNeeds",
            label: "General Integration Needs (describe)",
            cost: [1000, 4000],
            type: "textarea",
          },
          {
            id: "userRoles",
            label: "User Roles and Permissions",
            cost: [700, 2000],
            type: "checkbox",
          },
          {
            id: "authReqs",
            label: "Authentication Requirements",
            cost: [500, 1800],
            type: "checkbox",
          },
          {
            id: "dataHandling",
            label: "Data Handling Needs",
            cost: [1200, 3500],
            type: "checkbox",
          },
          {
            id: "reportingReqs",
            label: "Reporting Requirements",
            cost: [900, 3000],
            type: "checkbox",
          },
          {
            id: "searchFiltering",
            label: "Search & Filtering Functionality",
            cost: [600, 2000],
            type: "checkbox",
          },
        ];

        const technicalReqs = [
          {
            id: "platformPrefs",
            label: "Platform Preferences",
            cost: [1000, 3000],
            type: "textarea",
          }, // Changed to textarea for more detail
          {
            id: "techStack",
            label: "Technology Stack (Preferred)",
            cost: [1500, 5000],
            type: "textarea",
          },
          {
            id: "performanceNeeds",
            label: "Performance Needs (e.g., speed, concurrency)",
            cost: [800, 2500],
            type: "textarea",
          },
          {
            id: "securityReqs",
            label: "Security Requirements (e.g., GDPR/PCI DSS)",
            cost: [1200, 4000],
            type: "checkbox",
          },
          {
            id: "databaseReqs",
            label: "Database Requirements",
            cost: [1000, 3000],
            type: "textarea",
          },
          {
            id: "apiSpecs",
            label: "API Specifications",
            cost: [1000, 3500],
            type: "textarea",
          }, // Changed to textarea
          {
            id: "hostingReqs",
            label: "Hosting Requirements",
            cost: [500, 2000],
            type: "textarea",
          }, // Changed to textarea
          {
            id: "backupMonitoring",
            label: "Backup & Monitoring Needs",
            cost: [700, 2500],
            type: "checkbox",
          },
        ];

        const contentReqs = [
          {
            id: "contentTypes",
            label: "Content Types (e.g., text, images, video)",
            cost: [200, 1000],
            type: "textarea",
          }, // Changed to textarea
          {
            id: "contentSources",
            label: "Content Sources (who provides, where from)",
            cost: [0, 1500],
            type: "textarea",
          }, // Changed to textarea
          {
            id: "updateFrequency",
            label: "Update Frequency & Management",
            cost: [300, 1200],
            type: "textarea",
          }, // Changed to textarea
          {
            id: "seoReqs",
            label: "SEO Requirements",
            cost: [500, 2000],
            type: "checkbox",
            condition: "DigitalMarketing",
          }, // Simplified condition
          {
            id: "localizationNeeds",
            label: "Localization Needs (e.g., per language)",
            cost: [1000, 4000],
            type: "checkbox",
          },
          {
            id: "contentApproval",
            label: "Content Approval Process",
            cost: [200, 800],
            type: "checkbox",
          },
        ];

        const digitalMarketingServices = {
          "Search Engine Optimization (SEO)": [
            {
              id: "onPageSeo",
              label: "On-Page Optimization",
              cost: [500, 2000],
            },
            {
              id: "offPageSeo",
              label: "Off-Page Optimization",
              cost: [800, 3000],
            },
            { id: "technicalSeo", label: "Technical SEO", cost: [700, 2500] },
            { id: "localSeo", label: "Local SEO", cost: [400, 1500] },
          ],
          "Social Media": [
            {
              id: "smo",
              label: "Social Media Optimization (SMO)",
              cost: [600, 2000],
            },
            {
              id: "smm",
              label: "Social Media Marketing (SMM)",
              cost: [1000, 4000],
            },
          ],
          "Paid Advertising": [
            {
              id: "sem",
              label: "Search Engine Marketing (SEM)",
              cost: [800, 3000],
            },
            {
              id: "ppc",
              label: "Pay Per Click (PPC) Management",
              cost: [700, 2500],
            },
            {
              id: "multiPlatformAds",
              label: "Multi-Platform Ad Campaigns",
              cost: [1200, 5000],
            },
            {
              id: "displayAds",
              label: "Display Advertising & Remarketing",
              cost: [600, 2000],
            },
          ],
          "Content & Email Marketing": [
            // Note: 'Email Marketing' here is about *campaigns*, not the service itself
            {
              id: "dmEmailMarketing",
              label: "Email Marketing Campaigns",
              cost: [500, 2000],
            },
            {
              id: "contentMarketing",
              label: "Content Marketing (per piece/campaign)",
              cost: [300, 1500],
            },
          ],
          "Platforms to Manage": [
            { id: "tiktok", label: "Tik Tok", cost: [300, 800] },
            { id: "youtube", label: "YouTube", cost: [300, 800] },
            { id: "instagram", label: "Instagram", cost: [300, 800] },
            { id: "facebook", label: "Facebook", cost: [300, 800] },
            { id: "twitter", label: "Twitter (X)", cost: [300, 800] },
            { id: "linkedin", label: "LinkedIn", cost: [300, 800] },
            { id: "pinterest", label: "Pinterest", cost: [300, 800] },
            { id: "otherForums", label: "Other Forums", cost: [300, 800] },
          ],
        };

        const designServices = {
          "Logo & Brand Identity": [
            { id: "logoDesign", label: "Logo Design", cost: [800, 3000] },
            { id: "brandDesign", label: "Brand Design", cost: [2000, 7000] },
            {
              id: "brandStrategy",
              label: "Brand Strategy",
              cost: [1500, 5000],
            },
          ],
          "Marketing Materials": [
            { id: "bannerDesign", label: "Banner Design", cost: [200, 800] },
            { id: "flyerDesign", label: "Flyer Design", cost: [300, 1000] },
            {
              id: "brochureDesign",
              label: "Brochure Design",
              cost: [500, 1500],
            },
            {
              id: "businessCardDesign",
              label: "Business Card Design",
              cost: [150, 500],
            },
            {
              id: "letterheadDesign",
              label: "Letterhead & Envelope Design",
              cost: [200, 700],
            },
          ],
        };

        const systemUpdates = [
          {
            id: "websiteUpdate",
            label: "Website Update",
            cost: [1000, 5000],
            fields: [
              { name: "Current Platform", type: "text", idsuffix: "platform" },
              { name: "Requirements", type: "textarea", idsuffix: "reqs" },
            ],
          },
          {
            id: "applicationUpdate",
            label: "Application Update",
            cost: [1500, 7000],
            fields: [
              { name: "Current Version", type: "text", idsuffix: "version" },
              { name: "Update Scope", type: "textarea", idsuffix: "scope" },
            ],
          },
          {
            id: "databaseUpdate",
            label: "Database Update",
            cost: [800, 3000],
            fields: [
              { name: "Current Database", type: "text", idsuffix: "db" },
              { name: "Update Type", type: "textarea", idsuffix: "type" },
            ],
          },
          {
            id: "infrastructureUpdate",
            label: "Infrastructure Update",
            cost: [1200, 4500],
            fields: [
              { name: "Current Setup", type: "textarea", idsuffix: "setup" },
              { name: "Requirements", type: "textarea", idsuffix: "infrareqs" },
            ],
          },
          {
            id: "securityUpdate",
            label: "Security Update",
            cost: [1000, 4000],
            fields: [
              {
                name: "Current Measures",
                type: "textarea",
                idsuffix: "measures",
              },
              { name: "Requirements", type: "textarea", idsuffix: "secreqs" },
            ],
          },
          {
            id: "integrationUpdate",
            label: "Integration Update",
            cost: [700, 2500],
            fields: [
              {
                name: "Current Integrations",
                type: "textarea",
                idsuffix: "current",
              },
              {
                name: "New Integration Needs",
                type: "textarea",
                idsuffix: "new",
              },
            ],
          },
        ];

        const agreementText = `By submitting this form, you ("the Client") acknowledge that the information provided is for project estimation and initial understanding purposes. This document is not a final contract. ClickBit ("the Service Provider") will review your submission and may contact you for further discussion. A detailed proposal, including a final scope of work, definitive pricing, and complete terms and conditions, will be provided for your review and formal agreement after this initial consultation. The estimated project cost range provided in this form is an approximation; the actual price may be less or more depending on final requirements and negotiations.`;

        // --- STATE ---
        let currentPageIndex = 0;
        let pageOrder = ["page1", "page2"]; // Initial pages. Dynamically updated.

        // --- DOM ELEMENTS ---
        const formSections = document.querySelectorAll(".form-section");
        const prevBtn = document.getElementById("prevBtn");
        const nextBtn = document.getElementById("nextBtn");
        const submitBtn = document.getElementById("submitBtn");
        const onboardingFormWrapper =
          document.getElementById("onboarding-form");
        const serviceDetailsContainer = document.getElementById(
          "service-details-container"
        );

        // --- CUSTOM ALERT MODAL FUNCTIONS ---
        const customAlertModal = document.getElementById("custom-alert-modal");
        const alertTitle = document.getElementById("alert-title");
        const alertMessage = document.getElementById("alert-message");
        const alertOkBtn = document.getElementById("alert-ok-btn");

        function showAlert(title, message) {
          alertTitle.textContent = title;
          alertMessage.innerHTML = message;
          customAlertModal.classList.remove("hidden");
        }

        alertOkBtn.addEventListener("click", () => {
          customAlertModal.classList.add("hidden");
        });

        // --- INITIALIZATION ---
        populatePrimaryServices();
        populateCustomRequirements();
        populateDigitalMarketing();
        populateDesignServices();
        populateSystemUpdates();
        document.getElementById("agreement-text").innerText = agreementText;
        updateVisibleSectionsAndPageOrder(); // Initial determination of page order
        updateUI(); // Display the first page

        // Set initial date for clientDate
        const today = new Date();
        const yyyy = today.getFullYear();
        const mm = String(today.getMonth() + 1).padStart(2, "0");
        const dd = String(today.getDate()).padStart(2, "0");
        document.getElementById("clientDate").value = `${yyyy}-${mm}-${dd}`;

        // --- EVENT LISTENERS ---
        nextBtn.addEventListener("click", () => {
          if (validatePage(pageOrder[currentPageIndex])) {
            if (currentPageIndex < pageOrder.length - 1) {
              currentPageIndex++;
              updateUI();
              window.scrollTo(0, 0);
            }
          }
        });

        prevBtn.addEventListener("click", () => {
          if (currentPageIndex > 0) {
            currentPageIndex--;
            updateUI();
            window.scrollTo(0, 0);
          }
        });

        // Listen for changes on the form to update costs and conditional displays
        onboardingFormWrapper.addEventListener("change", (e) => {
          // Only update page order and visibility if a primary service is selected/deselected
          if (e.target.closest("#primary-services-container")) {
            updateVisibleSectionsAndPageOrder();
          }
          // If it's a cost-related input (checkbox or text with data-cost attributes)
          if (
            e.target.classList.contains("cost-input") ||
            e.target.classList.contains("cost-input-text")
          ) {
            updateCostDisplayForItem(e.target);
            calculateTotalCost();
          }
          // For checkbox groups, recalculate if any child is changed
          if (e.target.closest(".checkbox-group-container")) {
            calculateTotalCost();
          }
        });

        // Listen for input changes on text/number fields to update costs
        onboardingFormWrapper.addEventListener("input", (e) => {
          if (
            e.target.classList.contains("cost-input-text") ||
            e.target.type === "number"
          ) {
            updateCostDisplayForItem(e.target);
            calculateTotalCost();
          } else if (e.target.id === "maxBudget") {
            if (e.target.value < 0) {
              e.target.value = 0;
            }
            calculateTotalCost();
          }
        });

        document
          .querySelectorAll('input[name="budgetOption"]')
          .forEach((radio) => {
            radio.addEventListener("change", function () {
              document.getElementById("maxBudgetContainer").style.display =
                this.value === "yes" ? "block" : "none";
              calculateTotalCost();
            });
          });

        document
          .getElementById("maxBudget")
          .addEventListener("input", calculateTotalCost);
        document.getElementById("clientName").addEventListener("input", (e) => {
          document.getElementById("clientNameSign").value = e.target.value;
        });

        submitBtn.addEventListener("click", async () => {
          if (validatePage("page-agreement")) {
            const formData = {};
            document
              .querySelectorAll(
                "#onboarding-form-wrapper input, #onboarding-form-wrapper textarea, #onboarding-form-wrapper select"
              )
              .forEach((input) => {
                const sectionId = input.closest(".form-section")?.id;
                if (!sectionId) return; // Skip inputs not within a form section

                // For checkbox groups, collect values as an array
                if (
                  input.type === "checkbox" &&
                  input.name &&
                  input.name.startsWith("checkbox-group-")
                ) {
                  if (input.checked) {
                    if (!formData[sectionId]) formData[sectionId] = {};
                    if (!formData[sectionId][input.name])
                      formData[sectionId][input.name] = [];
                    formData[sectionId][input.name].push(input.value);
                  }
                } else if (
                  input.type === "checkbox" ||
                  input.type === "radio"
                ) {
                  if (input.checked) {
                    if (!formData[sectionId]) formData[sectionId] = {};
                    formData[sectionId][input.id || input.name] = input.value;
                  }
                } else {
                  if (!formData[sectionId]) formData[sectionId] = {};
                  formData[sectionId][input.id || input.name] = input.value;
                }
              });

            // Add selected primary services explicitly
            const selectedPrimaryServices = getSelectedPrimaryServices();
            formData["page2"] = {
              ...formData["page2"],
              primaryServices: selectedPrimaryServices,
            };

            const totalCostElement = document.getElementById("total-cost");
            if (totalCostElement) {
              if (!formData["page-timeline-budget"])
                formData["page-timeline-budget"] = {};
              formData["page-timeline-budget"]["estimatedProjectCostRange"] =
                totalCostElement.textContent;
            }
            const costBreakdownElement =
              document.getElementById("cost-breakdown");
            if (costBreakdownElement) {
              const breakdownText = Array.from(costBreakdownElement.children)
                .map((div) => div.textContent.trim())
                .join("\n");
              if (!formData["page-timeline-budget"])
                formData["page-timeline-budget"] = {};
              formData["page-timeline-budget"]["costBreakdown"] = breakdownText;
            }

            console.log("Form Data to be submitted:", formData);

            showAlert(
              "Submission Successful!",
              "Thank you! Your project request has been submitted for review. We will contact you shortly to provide a detailed proposal and formal agreement. **Note:** This is not the final agreement; that will follow upon discussion and your approval of our detailed invoice/estimate."
            );
          }
        });

        // --- FUNCTIONS ---

        /**
         * Updates the UI to show only the current active page and controls button visibility.
         * Scrolls to the top of the page.
         */
        function updateUI() {
          const formSections = document.querySelectorAll(".form-section");
          // Hide all sections first to ensure correct transition
          formSections.forEach((section) => {
            section.classList.remove("active");
            section.style.display = "none"; // Immediately hide
          });

          const currentPageId = pageOrder[currentPageIndex];
          const currentPage = document.getElementById(currentPageId);
          if (currentPage) {
            currentPage.style.display = "block"; // Ensure it's block before adding active
            void currentPage.offsetWidth; // Force reflow
            currentPage.classList.add("active"); // Add active for animation
          }

          prevBtn.style.display =
            currentPageIndex > 0 ? "inline-block" : "none";
          nextBtn.style.display =
            currentPageIndex < pageOrder.length - 1 ? "inline-block" : "none";
          submitBtn.style.display =
            currentPageIndex === pageOrder.length - 1 ? "inline-block" : "none";
        }

        /**
         * Retrieves an array of IDs for all currently selected primary services.
         * @returns {string[]} An array of selected primary service IDs.
         */
        function getSelectedPrimaryServices() {
          return Array.from(
            document.querySelectorAll(
              "#primary-services-container input:checked"
            )
          ).map((cb) => cb.value);
        }

        /**
         * Dynamically updates the pageOrder array and the visibility of conditional sub-sections.
         * This function builds the page navigation path based on user selections.
         */
        function updateVisibleSectionsAndPageOrder() {
          const currentPageIdBeforeUpdate = pageOrder[currentPageIndex];
          const selected = getSelectedPrimaryServices();
          pageOrder = ["page1", "page2"]; // Reset pageOrder to base pages

          // Add dynamic service detail pages based on selection
          selected.forEach((serviceId) => {
            if (coreServiceDetails[serviceId]) {
              const pageId = `page-detail-${serviceId}`;
              if (!pageOrder.includes(pageId)) {
                pageOrder.push(pageId);
              }
            }
          });

          // Re-render/manage visibility of service detail pages
          populateServiceDetailsPages();

          const hasAnyService = selected.length > 0;
          const hasDigitalMarketingService =
            selected.includes("DigitalMarketing");
          const hasDesignServiceCore = selected.includes("DesignService");
          const hasSystemUpdateService = selected.includes(
            "SystemUpdateService"
          );

          const servicesTriggeringDesignReqs = [
            "BusinessStarterPack",
            "WebService",
            "MobileService",
            "DesignService",
          ];
          const hasServiceTriggeringDesignReqs = selected.some((s) =>
            servicesTriggeringDesignReqs.includes(s)
          );

          const techServicesIds = [
            "DesktopService",
            "ServerService",
            "CloudService",
            "AIService",
            "DataService",
            "SecurityService",
            "NetworkService",
            "StorageService",
            "CRMService",
            "ERPService",
            "HRMService",
            "SCMService",
            "EmailService",
            "WebService",
            "MobileService",
            "SystemUpdateService",
          ];
          const hasTechRequirement = selected.some(
            (s) => techServicesIds.includes(s) && s !== "EmailService"
          );

          const customReqsPage = document.getElementById("page-custom-reqs");
          const designReqsSection = document.getElementById(
            "design-requirements-section"
          );
          const functionalReqsSection = document.getElementById(
            "functional-requirements-section"
          );
          const technicalReqsSection = document.getElementById(
            "technical-requirements-section"
          );
          const contentReqsSection = document.getElementById(
            "content-requirements-section"
          );
          const additionalReqsSection = document.getElementById(
            "additional-requirements-section"
          );
          const projectConstraintsSection = document.getElementById(
            "project-constraints-section"
          );
          const futureExpansionSection = document.getElementById(
            "future-expansion-section"
          );
          const digitalMarketingPage = document.getElementById(
            "page-digital-marketing"
          );
          const designServicesPage = document.getElementById(
            "page-design-services"
          );
          const systemUpdatesPage = document.getElementById(
            "page-system-updates"
          );

          // Order handling for System Update Service: comes after page2 and dynamic detail pages
          if (hasSystemUpdateService) {
            if (!pageOrder.includes("page-system-updates")) {
              pageOrder.push("page-system-updates");
            }
          } else {
            pageOrder = pageOrder.filter(
              (pageId) => pageId !== "page-system-updates"
            );
            systemUpdatesPage
              .querySelectorAll("input, textarea")
              .forEach((input) => {
                if (input.type === "checkbox") input.checked = false;
                else input.value = "";
              });
          }

          // Determine if 'page-custom-reqs' (General Requirements) should be included
          const willShowCustomReqsPage = hasAnyService;

          if (willShowCustomReqsPage) {
            if (!pageOrder.includes("page-custom-reqs")) {
              pageOrder.push("page-custom-reqs");
            }
          } else {
            pageOrder = pageOrder.filter(
              (pageId) => pageId !== "page-custom-reqs"
            );
          }

          // Manage visibility of sub-sections within the Custom Requirements page
          // Note: These now only hide/show IF the parent 'page-custom-reqs' is in pageOrder.
          designReqsSection.style.display =
            hasServiceTriggeringDesignReqs && willShowCustomReqsPage
              ? "block"
              : "none";

          // Hide Functional Requirements for Digital Marketing or Design Service when selected alone.
          let showFunctionalReqs = hasAnyService;
          if (
            selected.length === 1 &&
            (selected[0] === "DigitalMarketing" ||
              selected[0] === "DesignService")
          ) {
            showFunctionalReqs = false;
          }
          functionalReqsSection.style.display =
            showFunctionalReqs && willShowCustomReqsPage ? "block" : "none";

          technicalReqsSection.style.display =
            hasTechRequirement && willShowCustomReqsPage ? "block" : "none";

          // Hide Content Requirements for certain services
          const servicesThatDontNeedContent = [
            "StorageService",
            "CloudService",
            "AIService",
            "DataService",
            "SecurityService",
            "NetworkService",
            "ERPService",
            "HRMService",
            "SCMService",
            "EmailService",
          ];
          const shouldShowContentReqs = selected.some(
            (s) => !servicesThatDontNeedContent.includes(s)
          );
          contentReqsSection.style.display =
            shouldShowContentReqs && willShowCustomReqsPage ? "block" : "none";

          additionalReqsSection.style.display =
            hasAnyService && willShowCustomReqsPage ? "block" : "none";
          projectConstraintsSection.style.display =
            hasAnyService && willShowCustomReqsPage ? "block" : "none";
          futureExpansionSection.style.display =
            hasAnyService && willShowCustomReqsPage ? "block" : "none";

          // Digital Marketing Page
          if (hasDigitalMarketingService) {
            if (!pageOrder.includes("page-digital-marketing"))
              pageOrder.push("page-digital-marketing");
          } else {
            pageOrder = pageOrder.filter(
              (pageId) => pageId !== "page-digital-marketing"
            );
            digitalMarketingPage
              .querySelectorAll('input[type="checkbox"]')
              .forEach((input) => (input.checked = false));
          }

          // Design Services Page
          if (hasDesignServiceCore) {
            if (!pageOrder.includes("page-design-services"))
              pageOrder.push("page-design-services");
          } else {
            pageOrder = pageOrder.filter(
              (pageId) => pageId !== "page-design-services"
            );
            designServicesPage
              .querySelectorAll('input[type="checkbox"]')
              .forEach((input) => (input.checked = false));
          }

          // The rest of the page order (timeline, agreement)
          if (!pageOrder.includes("page-timeline-budget"))
            pageOrder.push("page-timeline-budget");
          if (!pageOrder.includes("page-agreement"))
            pageOrder.push("page-agreement");

          // Adjust currentPageIndex if the current page was removed from the flow
          if (!pageOrder.includes(currentPageIdBeforeUpdate)) {
            currentPageIndex =
              pageOrder.indexOf("page2") !== -1
                ? pageOrder.indexOf("page2")
                : 0;
          }

          calculateTotalCost();
          updateUI();
        }

        /**
         * Generates HTML for a form input element based on item properties.
         * This function now always renders the container div, hiding it if conditions are not met.
         * @param {object} item - The field item object.
         * @param {string} namePrefix - Prefix for input names/IDs for uniqueness in dynamic pages.
         * @returns {string} HTML string for the input field wrapped in a div.
         */
        function generateInputFieldHtml(item, namePrefix = "") {
          const low = item.cost ? item.cost[0] : 0;
          const high = item.cost ? item.cost[1] : 0;
          const requiredClass = item.required ? " required" : "";
          const commonClasses =
            "mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark";
          const costInputClass = low > 0 || high > 0 ? "cost-input-text" : ""; // Only add if it actually has a cost

          // Determine initial visibility based on condition
          let initialDisplay = "block";
          // Check if item.condition exists and is a string before attempting to split it
          if (typeof item.condition === "string" && item.condition) {
            const [targetId, targetValue] = item.condition.split(":");
            // For general requirements, target element might be a primary service checkbox.
            // We need to query the whole document for it.
            const targetElement = document.getElementById(targetId);
            let conditionMet = false;

            if (targetElement) {
              if (targetElement.type === "checkbox") {
                conditionMet = targetElement.checked;
              } else if (targetElement.type === "select-one") {
                conditionMet = targetElement.value === targetValue;
              } else if (targetElement.type === "radio") {
                const checkedRadio = document.querySelector(
                  `input[name="${targetId}"]:checked`
                );
                conditionMet =
                  checkedRadio && checkedRadio.value === targetValue;
              }
            }
            // If targetElement is not found (e.g., condition refers to an element not yet in DOM or on another page)
            // or if condition explicitly states a value (e.g., 'webType:E-commerce') but the value is absent,
            // we assume condition is not met for initial display.
            if (!conditionMet) {
              initialDisplay = "none";
            }
          }

          let fieldHtml = "";
          let labelHtml = `<label for="${item.id}" class="block text-sm font-medium text-gray-600${requiredClass}">${item.label}</label>`;
          const costSpanHtml =
            low === 0 && high === 0
              ? ""
              : `<span id="cost-${
                  item.id
                }" class="text-gray-500 font-normal ml-2 hidden">(Est: AUD$${low.toLocaleString()} - AUD$${high.toLocaleString()}${
                  item.perUnit ? ` per ${item.unitName}` : ""
                })</span>`;

          switch (item.type) {
            case "text":
            case "number":
              fieldHtml = `<input type="${item.type}" id="${
                item.id
              }" name="${namePrefix}${item.id}" ${
                item.type === "number" ? 'min="0"' : ""
              } data-cost-low="${low}" data-cost-high="${high}" data-per-unit="${
                item.perUnit || false
              }" data-unit-name="${
                item.unitName || ""
              }" class="${commonClasses} ${costInputClass}">`;
              break;
            case "textarea":
              fieldHtml = `<textarea id="${item.id}" name="${namePrefix}${item.id}" rows="2" data-cost-low="${low}" data-cost-high="${high}" class="${commonClasses} ${costInputClass}"></textarea>`;
              break;
            case "select":
              fieldHtml = `<select id="${item.id}" name="${namePrefix}${item.id}" data-cost-low="${low}" data-cost-high="${high}" class="${commonClasses} ${costInputClass} py-2 px-3">`;
              fieldHtml += `<option value="">Select...</option>`;
              item.options.forEach((option) => {
                fieldHtml += `<option value="${option}">${option}</option>`;
              });
              fieldHtml += `</select>`;
              break;
            case "checkbox":
              const descriptionHtml = item.description
                ? `<p class="text-xs text-gray-500">${item.description}</p>`
                : "";
              fieldHtml = `<div class="flex items-start">
                        <input id="${item.id}" name="${namePrefix}${item.id}" type="checkbox" data-cost-low="${low}" data-cost-high="${high}" class="cost-input h-4 w-4 text-clickbit-blue-dark border-gray-300 rounded focus:ring-clickbit-blue-dark mt-1">
                        <div class="ml-3 flex-grow">
                          <label for="${item.id}" class="block text-sm font-medium text-gray-700">${item.label}</label>
                          ${descriptionHtml}
                        </div>
                        ${costSpanHtml}
                    </div>`;
              // For standalone checkboxes, the entire div is the field container, and label is inside.
              return `<div style="display: ${initialDisplay};">${fieldHtml}</div>`;
            case "checkbox_group":
              let groupOptionsHtml = "";
              item.options.forEach((option) => {
                groupOptionsHtml += `<div class="flex items-center">
                            <input id="${option.id}" name="checkbox-group-${
                  item.id
                }" type="checkbox" value="${option.label}" data-cost-low="${
                  option.cost[0]
                }" data-cost-high="${
                  option.cost[1]
                }" class="cost-input h-4 w-4 text-clickbit-blue-dark border-gray-300 rounded focus:ring-clickbit-blue-dark">
                            <label for="${
                              option.id
                            }" class="ml-2 block text-sm font-medium text-gray-700">${
                  option.label
                }</label>
                            <span id="cost-${
                              option.id
                            }" class="text-gray-500 font-normal ml-2 hidden">(Est: AUD$${option.cost[0].toLocaleString()} - AUD$${option.cost[1].toLocaleString()})</span>
                        </div>`;
              });
              fieldHtml = `<div class="space-y-2 checkbox-group-container" data-cost-low="${low}" data-cost-high="${high}" id="${item.id}-group">
                        <label class="block text-sm font-medium text-gray-600${requiredClass}">${item.label}</label>
                        ${groupOptionsHtml}
                    </div>`;
              // For checkbox groups, the entire div is the field container.
              return `<div style="display: ${initialDisplay};">${fieldHtml}</div>`;
            case "yesno":
              fieldHtml = `<div class="mt-2 space-x-4">
                        <label class="inline-flex items-center">
                            <input type="radio" name="${item.id}" value="yes" class="form-radio h-4 w-4 text-clickbit-blue-dark">
                            <span class="ml-2">Yes</span>
                        </label>
                        <label class="inline-flex items-center">
                            <input type="radio" name="${item.id}" value="no" class="form-radio h-4 w-4 text-clickbit-blue-dark" checked>
                            <span class="ml-2">No</span>
                        </label>
                    </div>`;
              break;
          }
          return `<div style="display: ${initialDisplay};">${labelHtml}${fieldHtml}${costSpanHtml}</div>`;
        }

        /**
         * Populates the primary services selection section with checkboxes.
         */
        function populatePrimaryServices() {
          const container = document.getElementById(
            "primary-services-container"
          );
          container.innerHTML = primaryServices
            .map(
              (service) => `
                <div class="relative h-full">
                    <input type="checkbox" id="${service.id}" value="${
                service.id
              }" class="hidden cost-input peer"
                            data-cost-low="${
                              service.cost[0]
                            }" data-cost-high="${
                service.cost[1]
              }" data-label="${service.name}">
                    <label for="${
                      service.id
                    }" class="flex flex-col h-full p-4 border rounded-lg cursor-pointer text-left peer-checked:border-clickbit-blue-dark peer-checked:bg-clickbit-blue-dark peer-checked:bg-opacity-5 transition-colors duration-200">
                        <span class="font-semibold text-base text-gray-800 peer-checked:text-clickbit-blue-dark">${
                          service.name
                        }</span>
                        <span class="text-sm text-gray-500 mt-2">${
                          service.description || ""
                        }</span>
                    </label>
                </div>
            `
            )
            .join("");
        }

        /**
         * Populates custom requirements sections with relevant fields.
         */
        function populateCustomRequirements() {
          // Updated condition checks in designReqs to use a consistent string format
          document.getElementById("design-requirements-container").innerHTML =
            designReqs.map((item) => generateInputFieldHtml(item)).join("");
          document.getElementById(
            "functional-requirements-container"
          ).innerHTML = functionalReqs
            .map((item) => generateInputFieldHtml(item))
            .join("");
          document.getElementById(
            "technical-requirements-container"
          ).innerHTML = technicalReqs
            .map((item) => generateInputFieldHtml(item))
            .join("");
          document.getElementById("content-requirements-container").innerHTML =
            contentReqs.map((item) => generateInputFieldHtml(item)).join("");

          const additionalReqsInput = document.getElementById(
            "additionalRequirements"
          );
          if (additionalReqsInput) {
            const costSpan = document.getElementById(
              "additionalRequirementsCost"
            );
            if (costSpan) {
              if (
                additionalReqsInput.value !== null &&
                additionalReqsInput.value !== undefined &&
                additionalReqsInput.value.trim() !== ""
              ) {
                costSpan.classList.remove("hidden");
              } else {
                costSpan.classList.add("hidden");
              }
            }
          }
        }

        /**
         * Creates and manages the dynamic detail pages for selected core services.
         */
        function populateServiceDetailsPages() {
          const selectedServices = getSelectedPrimaryServices();
          serviceDetailsContainer.innerHTML = ""; // Clear previous dynamic pages

          selectedServices.forEach((serviceId, index) => {
            const serviceData = coreServiceDetails[serviceId];
            if (serviceData) {
              const pageId = `page-detail-${serviceId}`;
              let pageHtml = `
                        <div id="${pageId}" class="form-section">
                            <h2 class="text-2xl font-semibold mb-6 border-b pb-2 text-clickbit-blue-dark">Page ${
                              3 + index
                            }: ${serviceData.title}</h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    `;
              serviceData.fields.forEach((field) => {
                // We no longer check condition here, as generateInputFieldHtml handles initial display.
                pageHtml += generateInputFieldHtml(field, `${serviceId}-`); // Prefix IDs/names for uniqueness
              });
              pageHtml += `</div></div>`;
              serviceDetailsContainer.insertAdjacentHTML("beforeend", pageHtml);
            }
          });

          // Re-attach event listeners to newly created elements
          serviceDetailsContainer
            .querySelectorAll("input, textarea, select")
            .forEach((input) => {
              input.addEventListener("change", (e) => {
                // Trigger visibility update for the *specific service detail page* this input belongs to
                const currentDetailPageId =
                  e.target.closest(".form-section")?.id;
                if (currentDetailPageId) {
                  const associatedServiceId = currentDetailPageId.replace(
                    "page-detail-",
                    ""
                  );
                  updateServiceDetailPageFieldVisibility(associatedServiceId);
                }

                if (
                  e.target.classList.contains("cost-input") ||
                  e.target.classList.contains("cost-input-text") ||
                  e.target.type === "select-one"
                ) {
                  updateCostDisplayForItem(e.target);
                  calculateTotalCost();
                }
                // For checkbox groups, recalculate if any child is changed
                if (e.target.closest(".checkbox-group-container")) {
                  calculateTotalCost();
                }
              });
              input.addEventListener("input", (e) => {
                if (
                  e.target.classList.contains("cost-input-text") ||
                  e.target.type === "number"
                ) {
                  updateCostDisplayForItem(e.target);
                  calculateTotalCost();
                }
              });
            });
          // Initial cost display update for dynamically rendered fields
          serviceDetailsContainer
            .querySelectorAll(".cost-input, .cost-input-text")
            .forEach((input) => {
              if (
                (input.type === "checkbox" && input.checked) ||
                (input.type !== "checkbox" &&
                  input.value !== null &&
                  input.value.trim() !== "")
              ) {
                // Added null check
                updateCostDisplayForItem(input);
              }
            });
          // Initial visibility update for conditional fields within these new pages
          selectedServices.forEach((serviceId) =>
            updateServiceDetailPageFieldVisibility(serviceId)
          );
        }

        /**
         * Updates the visibility of conditional fields within a specific service detail page.
         * @param {string} serviceId - The ID of the primary service whose detail page fields need updating.
         */
        function updateServiceDetailPageFieldVisibility(serviceId) {
          const serviceData = coreServiceDetails[serviceId];
          if (!serviceData) return;

          const detailPage = document.getElementById(
            `page-detail-${serviceId}`
          );
          if (!detailPage) return;

          serviceData.fields.forEach((field) => {
            const inputElement = detailPage.querySelector(`#${field.id}`); // Find the input within the current detail page

            // IMPORTANT: Ensure the input element exists. It might not if the field's ID is not truly unique,
            // or if there's a typo. But with current logic, it should always exist.
            if (!inputElement) {
              // console.warn(`Input element with ID "${field.id}" not found on page-detail-${serviceId}.`);
              return;
            }

            // Get the parent div that wraps the field (the one with style.display property)
            // For checkbox/checkbox_group, the input IS inside the outermost div generated by generateInputFieldHtml.
            // For other types, the input is directly inside the outermost div.
            let fieldContainer = null;
            if (field.type === "checkbox" || field.type === "checkbox_group") {
              fieldContainer = inputElement.closest("div[style]"); // Find the closest div with an inline style, which should be the main container
            } else {
              fieldContainer = inputElement.parentElement; // For other types, its direct parent is the container
            }

            // If for some reason the container isn't found, log a warning and skip.
            if (!fieldContainer) {
              // console.warn(`Could not find field container for input with ID: ${field.id}`);
              return;
            }

            const costSpan = document.getElementById(`cost-${field.id}`);

            let isVisible = true;
            // Check if field.condition exists and is a string before attempting to split it
            if (typeof field.condition === "string" && field.condition) {
              const [targetId, targetValue] = field.condition.split(":");
              const targetInput = detailPage.querySelector(`#${targetId}`); // Look for the target input within the same detail page

              if (targetInput) {
                if (targetInput.type === "checkbox") {
                  isVisible = targetInput.checked;
                } else if (targetInput.type === "select-one") {
                  isVisible = targetInput.value === targetValue;
                } else if (targetInput.type === "radio") {
                  const checkedRadio = detailPage.querySelector(
                    `input[name="${targetId}"]:checked`
                  );
                  isVisible =
                    checkedRadio && checkedRadio.value === targetValue;
                }
              } else {
                // If the targetInput for condition is not found on the same page, keep it hidden.
                isVisible = false;
              }
            }

            fieldContainer.style.display = isVisible ? "block" : "none"; // Toggle display

            // If hidden, reset input and hide its cost
            if (!isVisible) {
              if (
                inputElement.type === "checkbox" ||
                inputElement.type === "radio"
              ) {
                inputElement.checked = false;
              } else if (inputElement.tagName === "SELECT") {
                inputElement.value = ""; // Reset select dropdown
              } else if (
                inputElement.type === "number" ||
                inputElement.type === "text" ||
                inputElement.tagName === "TEXTAREA"
              ) {
                inputElement.value = "";
              }
              // Reset all checkboxes within a checkbox_group if the group becomes hidden
              if (field.type === "checkbox_group") {
                inputElement
                  .querySelectorAll('input[type="checkbox"]')
                  .forEach((cb) => (cb.checked = false));
              }
              if (costSpan) costSpan.classList.add("hidden");
            } else {
              // If visible, re-evaluate cost span visibility based on current value/checked status
              if (costSpan) {
                // This checks if a visible input has a value/is checked that warrants showing its cost range
                if (
                  (inputElement.type === "checkbox" && inputElement.checked) ||
                  (inputElement.classList.contains("cost-input-text") &&
                    inputElement.value !== null &&
                    inputElement.value.trim() !== "") || // Added null check
                  (inputElement.tagName === "SELECT" &&
                    inputElement.value !== null &&
                    inputElement.value.trim() !== "") || // Added null check
                  (inputElement.type === "number" &&
                    inputElement.value !== "" &&
                    parseFloat(inputElement.value) > 0)
                ) {
                  costSpan.classList.remove("hidden");
                } else {
                  costSpan.classList.add("hidden");
                }
              }
            }
          });
          calculateTotalCost(); // Recalculate after changing visibility
        }

        /**
         * Populates a category section with checkboxes for services within that category.
         * @param {string|null} containerId - The ID of the container element to populate. If null, returns HTML string.
         * @param {Array<object>} servicesData - Array of service items for the category.
         * @param {string} title - The title of the category.
         * @returns {string|void} HTML string if containerId is null, otherwise populates the container directly.
         */
        function populateCategory(containerId, servicesData, title) {
          const container = containerId
            ? document.getElementById(containerId)
            : null;
          let html = `<div class="mb-8"><h3 class="text-xl font-semibold mb-4 text-gray-700">${title}</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-4">`;
          servicesData.forEach((item) => {
            // For sub-category checkboxes, their IDs are unique enough, but a group name is good for validation
            html += generateInputFieldHtml(
              { ...item, type: "checkbox" },
              title.replace(/\s+/g, "-").toLowerCase() + "-checkbox-"
            );
          });
          html += `</div></div>`;
          if (container) {
            container.innerHTML = html;
          }
          return html;
        }

        /**
         * Populates the digital marketing services section.
         */
        function populateDigitalMarketing() {
          const container = document.getElementById(
            "digital-marketing-container"
          );
          container.innerHTML = Object.entries(digitalMarketingServices)
            .map(([title, services]) => populateCategory(null, services, title))
            .join("");
        }

        /**
         * Populates the design services section.
         */
        function populateDesignServices() {
          const container = document.getElementById(
            "design-services-container"
          );
          container.innerHTML = Object.entries(designServices)
            .map(([title, services]) => populateCategory(null, services, title))
            .join("");
        }

        /**
         * Populates the existing system updates section with dynamic fields.
         */
        function populateSystemUpdates() {
          const container = document.getElementById("system-updates-container");
          container.innerHTML = systemUpdates
            .map(
              (item) => `
                <div class="p-4 border rounded-lg">
                    <div class="flex items-start">
                        <input id="${item.id}" type="checkbox" data-cost-low="${
                item.cost[0]
              }" data-cost-high="${
                item.cost[1]
              }" class="cost-input h-5 w-5 text-clickbit-blue-dark border-gray-300 rounded focus:ring-clickbit-blue-dark mt-1">
                        <div class="ml-3 flex-grow">
                            <label for="${
                              item.id
                            }" class="text-lg font-medium text-gray-800">${
                item.label
              }</label>
                            <span id="cost-${
                              item.id
                            }" class="text-gray-500 font-normal ml-2 hidden">(AUD$${item.cost[0].toLocaleString()} - AUD$${item.cost[1].toLocaleString()})</span>
                            <div class="mt-2 grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${item.fields
                                  .map(
                                    (field) => `
                                    <div>
                                        <label for="${item.id}-${
                                      field.idsuffix
                                    }" class="block text-sm font-medium text-gray-500">${
                                      field.name
                                    }</label>
                                        ${
                                          field.type === "textarea"
                                            ? `<textarea id="${item.id}-${field.idsuffix}" rows="2" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark text-sm"></textarea>`
                                            : `<input type="text" id="${item.id}-${field.idsuffix}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-clickbit-blue-dark focus:ring-clickbit-blue-dark text-sm">`
                                        }
                                    </div>
                                `
                                  )
                                  .join("")}
                            </div>
                        </div>
                    </div>
                </div>
            `
            )
            .join("");
        }

        /**
         * Toggles the visibility of the cost span next to an input element.
         * @param {HTMLElement} inputElement - The input element whose cost span needs updating.
         */
        function updateCostDisplayForItem(inputElement) {
          const costSpan = document.getElementById(`cost-${inputElement.id}`);
          if (costSpan) {
            let isSelected = false;
            if (inputElement.type === "checkbox") {
              isSelected = inputElement.checked;
            } else if (inputElement.classList.contains("cost-input-text")) {
              isSelected =
                inputElement.value !== null && inputElement.value.trim() !== ""; // Added null check
            } else if (inputElement.type === "number") {
              isSelected =
                inputElement.value !== "" && parseFloat(inputElement.value) > 0;
            } else if (inputElement.tagName === "SELECT") {
              isSelected =
                inputElement.value !== null && inputElement.value.trim() !== ""; // Added null check
            }

            if (isSelected) {
              costSpan.classList.remove("hidden");
            } else {
              costSpan.classList.add("hidden");
            }
          }
        }

        /**
         * Calculates the total estimated cost range based on all selected and filled-out cost-bearing inputs.
         * Updates the total cost display and breakdown.
         */
        function calculateTotalCost() {
          let low = 0;
          let high = 0;
          const breakdownItems = [];

          function getItemBreakdownLabel(inputElement) {
            if (inputElement.dataset.label) {
              return inputElement.dataset.label;
            }
            const labelElement =
              inputElement.labels && inputElement.labels[0]
                ? inputElement.labels[0]
                : null;
            if (labelElement) {
              return labelElement.textContent.replace(" *", "").trim();
            }
            if (inputElement.id === "additionalRequirements") {
              return "Additional Project Requirements";
            }
            // For dynamically created fields, use its ID and find its corresponding data object
            const serviceIdMatch = inputElement.id.match(/^(.+?)-/); // e.g., 'EmailService-'
            if (serviceIdMatch && coreServiceDetails[serviceIdMatch[1]]) {
              const fieldId = inputElement.id.substring(
                serviceIdMatch[1].length + 1
              ); // Get original field ID
              const serviceData = coreServiceDetails[serviceIdMatch[1]];
              const field = serviceData.fields.find((f) => f.id === fieldId);
              if (field)
                return `${field.label} (${serviceData.title.replace(
                  " Details",
                  ""
                )})`;
            }
            // For checkbox group children, the name attribute starts with "checkbox-group-"
            if (
              inputElement.name &&
              inputElement.name.startsWith("checkbox-group-")
            ) {
              const groupId = inputElement.name.replace("checkbox-group-", "");
              const serviceDetail = Object.values(coreServiceDetails).find(
                (service) =>
                  service.fields.some(
                    (f) => f.id === groupId && f.type === "checkbox_group"
                  )
              );
              if (serviceDetail) {
                const groupField = serviceDetail.fields.find(
                  (f) => f.id === groupId
                );
                if (groupField)
                  return `${inputElement.value} (${
                    groupField.label
                  } for ${serviceDetail.title.replace(" Details", "")})`;
              }
              // For global groups like digital marketing/design services
              const dmGroup = Object.values(digitalMarketingServices)
                .flat()
                .find((item) => item.id === inputElement.id);
              if (dmGroup) return `${dmGroup.label} (Digital Marketing)`;
              const dsGroup = Object.values(designServices)
                .flat()
                .find((item) => item.id === inputElement.id);
              if (dsGroup) return `${dsGroup.label} (Design Services)`;
            }
            return inputElement.id;
          }

          // Iterate over all form sections that are part of the current page flow
          pageOrder.forEach((pageId) => {
            const pageElement = document.getElementById(pageId);
            if (!pageElement) return;

            // Collect cost inputs within the current page, ensuring they are not within hidden conditional containers
            pageElement
              .querySelectorAll(".cost-input, .cost-input-text")
              .forEach((input) => {
                // Check if the input's actual visual container is displayed
                // For fields generated by generateInputFieldHtml, their outer div handles visibility
                const container = input.closest("div[style]"); // Look for the div that holds the display:none/block
                const isInputContainerVisible =
                  !container ||
                  (container && container.style.display !== "none");

                if (!isInputContainerVisible) {
                  return; // Skip hidden inputs
                }

                const costLow = parseFloat(input.dataset.costLow) || 0;
                const costHigh = parseFloat(input.dataset.costHigh) || 0;
                const isPerUnit = input.dataset.perUnit === "true";
                const unitValue = parseFloat(input.value) || 0;

                let shouldCount = false;

                if (input.type === "checkbox" && input.checked) {
                  shouldCount = true;
                } else if (
                  input.classList.contains("cost-input-text") &&
                  input.value !== null &&
                  input.value.trim() !== ""
                ) {
                  // Added null check
                  shouldCount = true;
                } else if (input.type === "number" && unitValue > 0) {
                  shouldCount = true;
                } else if (
                  input.tagName === "SELECT" &&
                  input.value !== null &&
                  input.value.trim() !== ""
                ) {
                  // Added null check
                  shouldCount = true;
                }
                // Special case for checkbox groups: The group itself might not have a direct value,
                // but its *children* do. If a child checkbox is checked, its cost is counted.
                if (
                  input.name &&
                  input.name.startsWith("checkbox-group-") &&
                  input.checked
                ) {
                  shouldCount = true;
                }

                if (shouldCount) {
                  let currentLow = costLow;
                  let currentHigh = costHigh;

                  if (isPerUnit && unitValue > 0) {
                    currentLow *= unitValue;
                    currentHigh *= unitValue;
                  }

                  low += currentLow;
                  high += currentHigh;

                  const itemLabel = getItemBreakdownLabel(input);
                  breakdownItems.push({
                    label: itemLabel,
                    low: currentLow,
                    high: currentHigh,
                  });
                }
              });
          });

          document.getElementById(
            "total-cost"
          ).textContent = `AUD$${low.toLocaleString()} - AUD$${high.toLocaleString()}`;

          const breakdownContainer = document.getElementById("cost-breakdown");
          if (breakdownItems.length > 0) {
            breakdownItems.sort((a, b) => a.label.localeCompare(b.label));

            breakdownContainer.innerHTML = breakdownItems
              .map(
                (item) => `
                    <div class="flex justify-between">
                        <span>${item.label}:</span>
                        <span class="font-medium">AUD$${item.low.toLocaleString()} - AUD$${item.high.toLocaleString()}</span>
                    </div>
                `
              )
              .join("");
          } else {
            breakdownContainer.innerHTML = `<p class="text-gray-500">No services or custom requirements selected yet.</p>`;
          }

          const budgetFeedback = document.getElementById("budget-feedback");
          const maxBudgetInput = document.getElementById("maxBudget");
          const budgetOptionYes = document.querySelector(
            'input[name="budgetOption"][value="yes"]'
          );

          if (budgetOptionYes && budgetOptionYes.checked) {
            const maxBudget = parseFloat(maxBudgetInput.value);
            if (maxBudget > 0 && low > maxBudget) {
              budgetFeedback.innerHTML = `<strong>Warning:</strong> The estimated minimum project cost (<strong>AUD$${low.toLocaleString()}</strong>) exceeds your specified budget of <strong>AUD$${maxBudget.toLocaleString()}</strong>.`;
              budgetFeedback.classList.remove("hidden");
            } else {
              budgetFeedback.classList.add("hidden");
              budgetFeedback.innerHTML = "";
            }
          } else {
            budgetFeedback.classList.add("hidden");
            budgetFeedback.innerHTML = "";
          }
        }

        /**
         * Validates the required fields on the current page.
         * Includes specific validation for email and phone formats, and new budget validation.
         * @param {string} pageId - The ID of the current page to validate.
         * @returns {boolean} True if all required fields are valid, false otherwise.
         */
        function validatePage(pageId) {
          let isValid = true;
          let firstInvalidInput = null;
          let alertAlreadyShown = false; // To prevent multiple alerts for the same validation pass

          const currentPage = document.getElementById(pageId);
          if (!currentPage) return true;

          // Select all inputs within the current page that are required OR part of a checkbox group
          // Fixed: Look for inputs that have labels with 'required' class, not inputs with 'required' class
          const inputsToValidate = currentPage.querySelectorAll(
            'input[type="email"], input[type="tel"], input[type="number"], input[type="date"], input[name^="checkbox-group-"], textarea, select'
          );

          const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          const phoneRegex = /^[\d\s\-\+\(\)]+$/;
          const today = new Date();
          today.setHours(0, 0, 0, 0);

          inputsToValidate.forEach((input) => {
            // Determine if the input's containing div is actually visible
            // For regular inputs, this is their immediate parent, for conditional inputs it's the `div[style]`
            const fieldContainer = input.closest("div[style], .grid > div"); // Adjust selector as needed
            const isFieldVisible = fieldContainer
              ? fieldContainer.style.display !== "none"
              : true;

            // Also check if the element is connected to the document and has a layout box
            const isActuallyVisibleInDOM = input.offsetParent !== null;

            if (!isFieldVisible || !isActuallyVisibleInDOM) {
              input.classList.remove(
                "border-red-500",
                "ring-red-500",
                "ring-1"
              );
              return; // Skip validation for hidden fields
            }

            input.classList.remove("border-red-500", "ring-red-500", "ring-1"); // Clear previous errors

            let fieldValid = true;

            // Handle primary service selection on page2 (already done by page-level check below)
            if (
              pageId === "page2" &&
              input.closest("#primary-services-container")
            ) {
              return;
            }

            // Check if this input is required by looking for its label with 'required' class
            const isRequired =
              input.labels &&
              Array.from(input.labels).some((label) =>
                label.classList.contains("required")
              );

            // General validation for required fields
            if (isRequired) {
              if (input.type === "checkbox" || input.type === "radio") {
                // For required checkboxes/radio buttons, check if at least one in the group is checked
                // This handles groups where `name` attribute is shared.
                if (
                  !document.querySelector(`input[name="${input.name}"]:checked`)
                ) {
                  fieldValid = false;
                }
              } else if (input.tagName === "SELECT" && !input.value) {
                fieldValid = false;
              }
              // For other required inputs (text, number, textarea, etc.)
              else {
                // Safely check if input.value is a string and not empty after trimming
                const inputValue = input.value;
                if (
                  inputValue === null ||
                  inputValue === undefined ||
                  (typeof inputValue === "string" && inputValue.trim() === "")
                ) {
                  fieldValid = false;
                }
              }
            }

            // --- Specific Format Validations ---
            if (fieldValid) {
              if (
                input.id === "email" &&
                typeof input.value === "string" &&
                input.value.trim() !== "" &&
                !emailRegex.test(input.value.trim())
              ) {
                // Added check for non-empty value before validating format
                fieldValid = false;
                if (!alertAlreadyShown) {
                  showAlert(
                    "Invalid Input",
                    "Please enter a valid email address."
                  );
                  alertAlreadyShown = true;
                }
              } else if (
                input.id === "phone" &&
                typeof input.value === "string" &&
                input.value.trim() !== "" &&
                !phoneRegex.test(input.value.trim())
              ) {
                // Added check for non-empty value before validating format
                fieldValid = false;
                if (!alertAlreadyShown) {
                  showAlert(
                    "Invalid Input",
                    "Please enter a valid phone number (digits, spaces, +, -, () are allowed)."
                  );
                  alertAlreadyShown = true;
                }
              } else if (input.type === "date" && input.value) {
                const inputDate = new Date(input.value);
                inputDate.setHours(0, 0, 0, 0);

                // Project Start Date and Completion Date should not be in the past
                if (
                  (input.id === "startDate" || input.id === "completionDate") &&
                  inputDate < today
                ) {
                  fieldValid = false;
                  if (!alertAlreadyShown) {
                    showAlert(
                      "Invalid Date",
                      `${input.labels[0]?.textContent
                        .trim()
                        .replace(" *", "")} cannot be a past date.`
                    );
                    alertAlreadyShown = true;
                  }
                } else if (
                  input.id === "completionDate" &&
                  document.getElementById("startDate").value
                ) {
                  const startDate = new Date(
                    document.getElementById("startDate").value
                  );
                  startDate.setHours(0, 0, 0, 0);
                  if (inputDate < startDate) {
                    fieldValid = false;
                    if (!alertAlreadyShown) {
                      showAlert(
                        "Invalid Date",
                        "Expected Completion Date cannot be before Project Start Date."
                      );
                      alertAlreadyShown = true;
                    }
                  }
                }
              } else if (
                input.type === "number" &&
                isRequired &&
                (input.value === "" || parseFloat(input.value) <= 0)
              ) {
                fieldValid = false;
                if (!alertAlreadyShown) {
                  showAlert(
                    "Invalid Input",
                    `Please enter a positive number for "${input.labels[0]?.textContent
                      .trim()
                      .replace(" *", "")}".`
                  );
                  alertAlreadyShown = true;
                }
              }
            }

            if (!fieldValid) {
              isValid = false;
              input.classList.add("border-red-500", "ring-red-500", "ring-1");
              if (!firstInvalidInput) {
                firstInvalidInput = input;
              }
            }
          });

          // --- Page-specific Validations ---

          // Page 1: Budget Validation
          if (pageId === "page1") {
            const budgetOptionYes = document.querySelector(
              'input[name="budgetOption"][value="yes"]'
            );
            const maxBudgetInput = document.getElementById("maxBudget");

            if (budgetOptionYes?.checked) {
              const maxBudgetVal = parseFloat(maxBudgetInput.value);
              if (isNaN(maxBudgetVal) || maxBudgetVal < 0) {
                isValid = false;
                maxBudgetInput.classList.add(
                  "border-red-500",
                  "ring-red-500",
                  "ring-1"
                );
                if (!firstInvalidInput) {
                  firstInvalidInput = maxBudgetInput;
                }
                if (!alertAlreadyShown) {
                  showAlert(
                    "Invalid Budget",
                    "Please enter a positive number (or zero) for your Maximum Project Budget."
                  );
                  alertAlreadyShown = true;
                }
              } else {
                maxBudgetInput.classList.remove(
                  "border-red-500",
                  "ring-red-500",
                  "ring-1"
                );
              }
            }
          }

          // Page 2: Service Selection (if no primary services selected)
          if (pageId === "page2") {
            const primaryServicesContainer = document.getElementById(
              "primary-services-container"
            );
            if (getSelectedPrimaryServices().length === 0) {
              isValid = false;
              primaryServicesContainer.classList.add(
                "border",
                "border-red-500",
                "p-2",
                "rounded-lg"
              );
              if (!firstInvalidInput) {
                firstInvalidInput = primaryServicesContainer;
              }
              if (!alertAlreadyShown) {
                showAlert(
                  "Validation Error",
                  "Please select at least one primary service."
                );
                alertAlreadyShown = true;
              }
            } else {
              primaryServicesContainer.classList.remove(
                "border",
                "border-red-500",
                "p-2",
                "rounded-lg"
              );
            }
          }

          // General alert if other required fields are missing
          if (!isValid && firstInvalidInput && !alertAlreadyShown) {
            showAlert(
              "Validation Error",
              "Please fill out all required fields (*) on this page before continuing."
            );
          }

          // Scroll to the first invalid input if validation fails
          if (!isValid && firstInvalidInput) {
            firstInvalidInput.scrollIntoView({
              behavior: "smooth",
              block: "center",
            });
            firstInvalidInput.focus();
          }

          return isValid;
        }

        // Initial update of cost display for all items on load
        document
          .querySelectorAll(".cost-input, .cost-input-text, select")
          .forEach((input) => {
            // This is primarily for text inputs or select elements that might have pre-filled values
            // and their cost should be reflected on load. Checkboxes are handled by their 'change' event.
            if (
              (input.classList.contains("cost-input-text") &&
                input.value !== null &&
                input.value.trim() !== "") || // Added null check
              (input.type === "number" && input.value !== "") ||
              (input.tagName === "SELECT" &&
                input.value !== null &&
                input.value.trim() !== "")
            ) {
              // Added null check
              updateCostDisplayForItem(input);
            }
            // For checkboxes, if they are checked by default (e.g. from a previous session or by HTML default), show cost
            if (input.type === "checkbox" && input.checked) {
              updateCostDisplayForItem(input);
            }
          });
        calculateTotalCost();
      });
    </script>
  </body>
</html>
